<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Courier Logbook Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Soft Modern Design */
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --light: #f8fafc;
            --dark: #1e293b;
            --soft-gray: #f1f5f9;
            --border-light: #e2e8f0;
            --border-dark: #334155;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --shadow-soft: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 6px rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.1);
            --shadow-hover: 0 10px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
            --shadow-strong: 0 20px 40px rgba(0,0,0,0.1), 0 8px 20px rgba(0,0,0,0.05);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            --gradient-secondary: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            --gradient-soft: linear-gradient(135deg, #f1f5f9 0%, #ffffff 100%);
        }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* Global animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(30px);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(129, 140, 248, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(241, 245, 249, 0.5) 0%, transparent 50%);
            animation: float 8s ease-in-out infinite;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--border-light);
            border-radius: 24px;
            box-shadow: var(--shadow-strong);
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            animation: fadeInScale 0.8s ease-out;
            position: relative;
            z-index: 1;
            transition: var(--transition-smooth);
            backdrop-filter: blur(20px);
        }

        .login-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-light);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
            animation: fadeInUp 1s ease-out 0.2s both;
        }
        
        .login-header h2 {
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 2rem;
            letter-spacing: -0.02em;
        }
        
        .login-header p {
            color: var(--text-secondary);
            margin: 0;
            font-weight: 400;
            font-size: 1rem;
        }

        .login-header i {
            animation: float 3s ease-in-out infinite;
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .form-control {
            border-radius: 16px;
            padding: 16px 20px;
            border: 1px solid var(--border-light);
            transition: var(--transition-smooth);
            background: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            position: relative;
            animation: fadeInUp 0.6s ease-out both;
            font-weight: 400;
            backdrop-filter: blur(10px);
        }

        .form-control:nth-child(1) { animation-delay: 0.3s; }
        .form-control:nth-child(2) { animation-delay: 0.4s; }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
            outline: none;
        }

        .form-control:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .btn-login {
            background: var(--gradient-primary);
            border: none;
            border-radius: 16px;
            padding: 16px 32px;
            font-weight: 600;
            transition: var(--transition-bounce);
            font-size: 1rem;
            animation: fadeInUp 0.6s ease-out 0.5s both;
            position: relative;
            overflow: hidden;
            color: #ffffff;
            letter-spacing: 0.02em;
            box-shadow: var(--shadow-medium);
        }

        .btn-login::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .btn-login:hover::before {
            left: 100%;
        }
        
        .btn-login:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: #ffffff;
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-hover);
        }

        .btn-login:active {
            transform: translateY(-2px) scale(0.98);
        }
        
        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }
        
        .alert {
            border-radius: 16px;
            border: none;
            backdrop-filter: blur(10px);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 500;
            transition: var(--transition-smooth);
            border: 1px solid transparent;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            border-color: var(--primary);
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .btn-outline-secondary {
            border-color: var(--border-light);
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.8);
        }
        
        .btn-outline-secondary:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: #ffffff;
            transform: translateY(-2px);
        }
        
        .main-container {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            min-height: 100vh;
            animation: fadeInUp 0.8s ease-out;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid var(--border-light);
            padding: 1.5rem 0;
            animation: fadeInUp 0.6s ease-out;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(20px);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.8rem;
            transition: var(--transition-smooth);
            letter-spacing: -0.02em;
        }

        .navbar-brand:hover {
            transform: scale(1.05);
            color: var(--primary);
        }
        
        .nav-link {
            font-weight: 600;
            margin: 0 8px;
            border-radius: 12px;
            transition: var(--transition-smooth);
            color: var(--text-secondary) !important;
            padding: 10px 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: left 0.3s ease;
            z-index: -1;
        }
        
        .nav-link:hover::before, .nav-link.active::before {
            left: 0;
        }
        
        .nav-link:hover, .nav-link.active {
            background: transparent;
            color: #ffffff !important;
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }
        
        .card {
            border: 1px solid var(--border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 2rem;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.95);
            transition: var(--transition-smooth);
            animation: fadeInUp 0.6s ease-out;
            backdrop-filter: blur(10px);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-light);
        }
        
        .card-header {
            background: var(--gradient-primary);
            color: #ffffff;
            font-weight: 700;
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #1a1a1a;
            font-size: 1.2rem;
            letter-spacing: -0.01em;
        }
        
        .card-body {
            padding: 2rem;
            background: #ffffff;
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            transition: var(--transition-bounce);
            padding: 12px 24px;
            border: 2px solid #000000;
            position: relative;
            overflow: hidden;
            font-size: 0.95rem;
            letter-spacing: 0.02em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-soft);
        }

        .btn:active {
            transform: translateY(-2px) scale(0.98);
        }
        
        .btn-primary {
            background: #000000;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #ffffff;
            color: #000000;
        }

        .btn-secondary {
            background: #ffffff;
            color: #000000;
        }

        .btn-secondary:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-success {
            background: #000000;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #ffffff;
            color: #000000;
        }

        .btn-danger {
            background: #000000;
            color: #ffffff;
        }

        .btn-danger:hover {
            background: #ffffff;
            color: #000000;
        }
        
        .badge {
            border-radius: 8px;
            font-weight: 600;
            padding: 8px 16px;
            border: 1px solid #000000;
        }

        .badge-primary {
            background: #000000;
            color: #ffffff;
        }

        .badge-secondary {
            background: #ffffff;
            color: #000000;
        }

        .badge-success {
            background: #000000;
            color: #ffffff;
        }

        .badge-warning {
            background: #000000;
            color: #ffffff;
        }

        .badge-danger {
            background: #000000;
            color: #ffffff;
        }
        
        .table {
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #1a1a1a;
        }
        
        .table thead th {
            background: var(--gradient-primary);
            border: none;
            font-weight: 700;
            color: #ffffff;
            padding: 1.2rem;
            font-size: 0.95rem;
            letter-spacing: 0.02em;
        }
        
        .table tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: var(--transition-smooth);
        }

        .table tbody tr:hover {
            background: rgba(0,0,0,0.02);
            transform: translateX(5px);
            box-shadow: var(--shadow-soft);
        }
        
        .table tbody td {
            padding: 1.2rem;
            vertical-align: middle;
            font-weight: 500;
        }
        
        .entry-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid #000000;
            transition: var(--transition-smooth);
        }

        .entry-photo:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-soft);
        }
        
        .committed-entry {
            background: rgba(0,0,0,0.02);
            border-left: 4px solid #000000;
        }
        
        .edit-request-badge {
            background: #000000;
            color: #ffffff;
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .activity-item {
            border-left: 4px solid #000000;
            background: #ffffff;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 0 12px 12px 0;
            border: 2px solid #e0e0e0;
            transition: var(--transition-smooth);
            animation: slideInRight 0.6s ease-out;
        }

        .activity-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-soft);
            border-color: #000000;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #000000;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: var(--transition-smooth);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-soft);
        }
        
        .modal-header {
            background: #000000;
            color: #ffffff;
            border-radius: 16px 16px 0 0;
            border-bottom: 2px solid #000000;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }
        
        .modal-content {
            border-radius: 16px;
            border: 2px solid #000000;
            animation: fadeInScale 0.4s ease-out;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 12px;
            margin-top: 10px;
            border: 2px solid #000000;
            transition: var(--transition-smooth);
            animation: fadeInScale 0.6s ease-out;
        }

        .photo-preview:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-soft);
        }
        
        .remarks-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1rem;
            background: #ffffff;
        }

        .remarks-list:hover {
            border-color: #000000;
        }

        .form-label {
            font-weight: 600;
            color: #000000;
            margin-bottom: 0.5rem;
        }

        .alert {
            border-radius: 12px;
            border: 2px solid #000000;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(0,0,0,0.02);
            color: #000000;
        }

        .alert-danger {
            background: rgba(0,0,0,0.02);
            color: #000000;
        }

        .alert-warning {
            background: rgba(0,0,0,0.02);
            color: #000000;
        }

        .alert-info {
            background: rgba(0,0,0,0.02);
            color: #000000;
        }

        .dropdown-menu {
            border: 2px solid #1a1a1a;
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(10px);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }

        body.dark-mode .login-container {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        body.dark-mode .login-card {
            background: rgba(30, 41, 59, 0.95);
            border-color: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .navbar {
            background: rgba(30, 41, 59, 0.95);
            border-bottom-color: #334155;
        }

        body.dark-mode .card {
            background: rgba(30, 41, 59, 0.95);
            border-color: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .form-control {
            background: rgba(51, 65, 85, 0.8);
            border-color: #475569;
            color: #e2e8f0;
        }

        body.dark-mode .form-control:focus {
            background: rgba(51, 65, 85, 0.95);
            border-color: var(--primary-light);
        }

        /* New Feature: Quick Actions Panel */
        .quick-actions-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 1rem;
            box-shadow: var(--shadow-soft);
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .quick-actions-panel.dark-mode {
            background: rgba(30, 41, 59, 0.95);
            border-color: #334155;
            color: #e2e8f0;
        }

        .quick-action-btn {
            display: block;
            width: 100%;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            background: #f8f9fa;
            color: #1a1a1a;
            text-decoration: none;
            transition: var(--transition-smooth);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .quick-action-btn:hover {
            background: #1a1a1a;
            color: #ffffff;
            transform: translateX(-5px);
        }

        .quick-action-btn.dark-mode {
            background: #2a2a2a;
            border-color: #3a3a3a;
            color: #e0e0e0;
        }

        .quick-action-btn.dark-mode:hover {
            background: #4a4a4a;
            color: #ffffff;
        }

        /* New Feature: Search and Filter Bar */
        .search-filter-bar {
            background: #f8f9fa;
            border: 2px solid #e8e8e8;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .search-filter-bar.dark-mode {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #e0e0e0;
        }

        /* New Feature: Statistics Dashboard */
        .stats-dashboard {
            background: var(--gradient-secondary);
            border: 2px solid #e8e8e8;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .stats-dashboard.dark-mode {
            background: var(--gradient-primary);
            border-color: #2a2a2a;
            color: #e0e0e0;
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid #e8e8e8;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition-smooth);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-soft);
        }

        .stat-card.dark-mode {
            background: #2a2a2a;
            border-color: #3a3a3a;
            color: #e0e0e0;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .stat-number.dark-mode {
            color: #e0e0e0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #4a4a4a;
            font-weight: 500;
        }

        .stat-label.dark-mode {
            color: #b0b0b0;
        }

        /* Notification System */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffffff;
            border: 2px solid #1a1a1a;
            border-radius: 16px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-soft);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
        }

        .notification-toast.dark-mode {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #e0e0e0;
        }

        .notification-toast.success {
            border-left: 4px solid #2d5a2d;
        }

        .notification-toast.error {
            border-left: 4px solid #5a2d2d;
        }

        .notification-toast.warning {
            border-left: 4px solid #5a4a2d;
        }

        .notification-toast.info {
            border-left: 4px solid #2d4a5a;
        }

        /* Enhanced Button Styles */
        .btn-modern {
            background: var(--gradient-primary);
            border: 2px solid #1a1a1a;
            border-radius: 16px;
            padding: 12px 24px;
            font-weight: 600;
            transition: var(--transition-bounce);
            color: #ffffff;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-modern:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-hover);
        }

        /* Loading States */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        .loading-shimmer.dark-mode {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
        }

        /* Responsive Design Improvements */
        @media (max-width: 768px) {
            .quick-actions-panel {
                position: fixed;
                bottom: 20px;
                right: 20px;
                top: auto;
                transform: none;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }

            .quick-actions-panel.expanded {
                width: 200px;
                height: auto;
                border-radius: 16px;
                padding: 1rem;
            }

            .quick-action-btn {
                display: none;
            }

            .quick-actions-panel.expanded .quick-action-btn {
                display: block;
            }

            .stats-dashboard .row {
                margin: 0 -0.5rem;
            }

            .stats-dashboard .col-md-3 {
                padding: 0 0.5rem;
                margin-bottom: 1rem;
            }
        }
            background: #ffffff;
        }

        .dropdown-item {
            font-weight: 500;
            transition: var(--transition-smooth);
        }

        .dropdown-item:hover {
            background: rgba(0,0,0,0.05);
            color: #000000;
        }

        .pagination .page-link {
            border: 2px solid #e0e0e0;
            color: #000000;
            font-weight: 600;
            transition: var(--transition-smooth);
        }

        .pagination .page-link:hover {
            background: #000000;
            color: #ffffff;
            border-color: #000000;
        }

        .pagination .page-item.active .page-link {
            background: #000000;
            border-color: #000000;
            color: #ffffff;
        }

        .progress {
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            background: #ffffff;
        }

        .progress-bar {
            background: #000000;
            border-radius: 10px;
        }

        .tooltip {
            background: #000000;
            color: #ffffff;
            border-radius: 8px;
            font-weight: 500;
        }

        .popover {
            border: 2px solid #000000;
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
        }

        .popover-header {
            background: #000000;
            color: #ffffff;
            border-bottom: 2px solid #000000;
            font-weight: 700;
        }

        .list-group-item {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            transition: var(--transition-smooth);
        }

        .list-group-item:hover {
            border-color: #000000;
            background: rgba(0,0,0,0.02);
        }

        .list-group-item.active {
            background: #000000;
            border-color: #000000;
            color: #ffffff;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #000000;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #333333;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .login-card {
                margin: 1rem;
                padding: 2rem;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .table-responsive {
                border: 2px solid #000000;
                border-radius: 12px;
            }
        }

        /* Loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Focus states for accessibility */
        .btn:focus,
        .form-control:focus,
        .nav-link:focus {
            outline: 2px solid #000000;
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            .btn, .navbar, .modal {
                display: none !important;
            }
            
            .card {
                border: 1px solid #000000;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-clipboard-list fa-3x text-primary mb-3"></i>
                <h2>VM Courier Logbook</h2>
                <p>Village Mall Portal</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginId" class="form-label">User ID</label>
                    <input type="text" class="form-control" id="loginId" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-login">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </button>
                </div>
            </form>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
            
            <!-- Demo Login Info -->
            <div class="mt-4 p-3 bg-light rounded-3" style="background: rgba(241, 245, 249, 0.5) !important; border: 1px solid var(--border-light);">
                <small class="text-muted">
                    <strong>Demo Login:</strong><br>
                    ID: <code>7434</code> | Password: <code>Danial05</code><br>
                    ID: <code>4545</code> | Password: <code>Ain123</code>
                </small>
            </div>
        </div>
    </div>
    <!-- Main Application -->
    <div id="mainApp" class="main-container" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <span class="navbar-brand">
                    <i class="fas fa-clipboard-list me-2"></i>VM Courier Logbook
                </span>
                <div class="navbar-nav ms-auto">
                    <!-- Management Dropdown -->
                    <div class="nav-item management-dropdown me-2">
                        <a class="nav-link" href="#">
                            <i class="fas fa-cogs me-1"></i>Management
                        </a>
                        <div class="management-menu">
                            <a class="management-item" href="#" onclick="showPage('logbook')">
                                <i class="fas fa-book me-2"></i>Logbook
                            </a>
                            <a class="management-item" href="#" onclick="showPage('users')">
                                <i class="fas fa-users me-2"></i>Users
                            </a>
                        </div>
                    </div>
                    
                    <!-- Admin Approvals (only visible to admins) -->
                    <a class="nav-link me-2" id="adminApprovalsLink" href="#" onclick="showPage('adminApprovals')" style="display: none;">
                        <i class="fas fa-clipboard-check me-1"></i>Admin Approvals
                        <span id="adminApprovalBadge" class="notification-badge" style="display: none;">0</span>
                    </a>
                    
                    <!-- Dark Mode Toggle -->
                    <div class="nav-item me-3">
                        <button class="btn btn-outline-secondary" onclick="toggleDarkMode()" id="darkModeToggle">
                            <i class="fas fa-moon me-1"></i>Dark Mode
                        </button>
                    </div>
                    
                    <!-- Profile Dropdown -->
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown">
                            <div class="user-avatar d-inline-flex me-2" id="userAvatar"></div>
                            <span id="currentUserName"></span>
                            <span id="editRequestBadge" class="notification-badge" style="display: none;">0</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="toggleDebug()">
                                <i class="fas fa-bug me-2"></i>Toggle Debug
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="forceSync()">
                                <i class="fas fa-sync me-2"></i>Force Sync Now
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>Export Data
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Real-time Sync Indicator -->
        <div id="realTimeIndicator" class="real-time-indicator">
            <i class="fas fa-sync-alt me-1"></i>Syncing...
        </div>
        
        <!-- Session Timer -->
        <div id="sessionTimer" class="session-timer">
            <i class="fas fa-clock me-1"></i>Session expires in: <span id="sessionTimeLeft">5:00</span>
        </div>
        
        <!-- Logbook Page -->
        <div id="logbookPage" class="page-section active">
            <div class="container mt-4">
                <!-- Enhanced Stats Dashboard -->
                <div class="stats-dashboard" id="statsDashboard">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card" id="statCard1">
                                <div class="stat-number" id="totalEntries">0</div>
                                <div class="stat-label">Total Entries</div>
                                <i class="fas fa-clipboard-list fa-2x mt-2 opacity-75"></i>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" id="statCard2">
                                <div class="stat-number" id="committedEntries">0</div>
                                <div class="stat-label">Committed</div>
                                <i class="fas fa-lock fa-2x mt-2 opacity-75"></i>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" id="statCard3">
                                <div class="stat-number" id="myEntries">0</div>
                                <div class="stat-label">My Entries</div>
                                <i class="fas fa-user fa-2x mt-2 opacity-75"></i>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" id="statCard4">
                                <div class="stat-number" id="pendingRequests">0</div>
                                <div class="stat-label">Edit Requests</div>
                                <i class="fas fa-exclamation-triangle fa-2x mt-2 opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Bar -->
                <div class="search-filter-bar" id="searchFilterBar">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="searchInput" class="form-label">Search Entries</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search by ID, PIC, destination...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In transit">In transit</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Return">Return</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="courierFilter" class="form-label">Courier</label>
                                <select class="form-select" id="courierFilter">
                                    <option value="">All Couriers</option>
                                    <option value="eDHL">eDHL</option>
                                    <option value="Poslaju">Poslaju</option>
                                    <option value="GDex">GDex</option>
                                    <option value="Others">Others</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="dateFilter" class="form-label">Date Range</label>
                                <select class="form-select" id="dateFilter">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="applyFilters()">
                                    <i class="fas fa-filter me-1"></i>Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add Entry Button -->
                <div class="row mb-3">
                    <div class="col">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#entryModal" onclick="openAddEntryModal()">
                            <i class="fas fa-plus me-2"></i>Add New Entry
                        </button>
                        <button id="viewDeletedBtn" class="btn btn-outline-secondary ms-2" onclick="toggleDeletedEntries()" style="display: none;">
                            <i class="fas fa-trash me-2"></i>View Deleted Entries
                        </button>
                    </div>
                </div>
                <!-- Logbook Entries -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Logbook Entries
                            <span id="entriesTitle">All Entries</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>PIC</th>
                                        <th>Destination</th>
                                        <th>Cashbill*</th>
                                        <th>Consignment*</th>
                                        <th>Courier Type</th>
                                        <th>Status</th>
                                        <th>Photo</th>
                                        <th>Remarks</th>
                                        <th>Entry Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- User Management Page -->
        <div id="usersPage" class="page-section">
            <div class="container mt-4">
                <div class="row">
                    <!-- User Profile/List -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i><span id="usersTitle">User Management</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="usersList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Log (Admin Only) -->
                    <div class="col-md-4" id="activityLogSection" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-history me-2"></i>Recent Activity
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="activityLog" style="max-height: 400px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Approvals Page -->
        <div id="adminApprovalsPage" class="page-section">
            <div class="container mt-4">
                <div class="row">
                    <div class="col-12">
                        <div class="card admin-approvals-card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-clipboard-check me-2"></i>Admin Approvals
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Edit Requests Section -->
                                <div class="approval-section">
                                    <h6 class="approval-header">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Pending Edit Requests
                                        <span class="badge bg-warning ms-2" id="editRequestsCount">0</span>
                                    </h6>
                                    <div id="editRequestsList">
                                        <p class="text-muted">No pending edit requests.</p>
                                    </div>
                                </div>
                                
                                <!-- Uncommitted Entries Section -->
                                <div class="approval-section">
                                    <h6 class="approval-header">
                                        <i class="fas fa-clock me-2"></i>Entries Awaiting Re-commit Approval
                                        <span class="badge bg-info ms-2" id="uncommittedCount">0</span>
                                    </h6>
                                    <div id="uncommittedEntriesList">
                                        <p class="text-muted">No entries awaiting re-commit approval.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Entry Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryModalTitle">Add New Entry</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="entryForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="entryDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryPIC" class="form-label">PIC (Person in Charge)</label>
                                    <input type="text" class="form-control" id="entryPIC" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="entryDestination" class="form-label">Destination Trade In Partner</label>
                            <select class="form-select" id="entryDestination" required>
                                <option value="">Select Destination</option>
                                <option value="ENB">ENB</option>
                                <option value="Remobie">Remobie</option>
                                <option value="Miifix">Miifix</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryCashbill" class="form-label">Cashbill Number *</label>
                                    <input type="text" class="form-control" id="entryCashbill" required placeholder="Enter cashbill number">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryConsignment" class="form-label">Consignment Number *</label>
                                    <input type="text" class="form-control" id="entryConsignment" required placeholder="Enter consignment number">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryCourierType" class="form-label">Courier Type</label>
                                    <select class="form-select" id="entryCourierType" required>
                                        <option value="">Select Courier</option>
                                        <option value="eDHL">eDHL</option>
                                        <option value="Poslaju">Poslaju</option>
                                        <option value="GDex">GDex</option>
                                        <option value="Others">Others</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryStatus" class="form-label">Status</label>
                                    <select class="form-select" id="entryStatus" required>
                                        <option value="">Select Status</option>
                                        <option value="Pending">Pending</option>
                                        <option value="In transit">In transit</option>
                                        <option value="Delivered">Delivered</option>
                                        <option value="Return">Return</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="entryPhoto" class="form-label">Courier Photo Proof</label>
                            <input type="file" class="form-control" id="entryPhoto" accept="image/*">
                            <div id="photoPreview"></div>
                        </div>
                        <div class="mb-3">
                            <label for="entryRemarks" class="form-label">Initial Remarks (Optional)</label>
                            <textarea class="form-control" id="entryRemarks" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEntry()">
                        <span id="saveButtonText">Save Entry</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Remarks Modal -->
    <div class="modal fade" id="remarksModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Entry Remarks</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="remarks-list" id="remarksList"></div>
                    <div class="mt-3">
                        <label for="newRemark" class="form-label">Add New Remark</label>
                        <textarea class="form-control" id="newRemark" rows="3" placeholder="Enter your remark..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addRemark()">Add Remark</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Request Modal -->
    <div class="modal fade" id="editRequestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Edit Permission</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This entry is committed and locked. Please provide a reason for requesting edit permission:</p>
                    <textarea class="form-control" id="editRequestReason" rows="4" placeholder="Reason for edit request..." required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitEditRequest()">Submit Request</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Photo View Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Courier Photo Proof</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPhoto" class="img-fluid" style="max-height: 70vh;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Contact Modal -->
    <div class="modal fade" id="adminContactModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Contact Required</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>This entry is committed and locked.</strong><br>
                        To edit this entry, please contact the administrator:<br><br>
                        <strong>Danial Danish</strong><br>
                        ID: 7434<br>
                        <i class="fas fa-phone me-2"></i> Contact for uncommit permission
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
            <!-- Quick Actions Panel -->
        <div class="quick-actions-panel" id="quickActionsPanel" style="display: none;">
            <h6 class="mb-3 text-center">Quick Actions</h6>
            <a href="#" class="quick-action-btn" onclick="openAddEntryModal()">
                <i class="fas fa-plus me-2"></i>Add Entry
            </a>
            <a href="#" class="quick-action-btn" onclick="forceSync()">
                <i class="fas fa-sync me-2"></i>Sync Now
            </a>
            <a href="#" class="quick-action-btn" onclick="exportData()">
                <i class="fas fa-download me-2"></i>Export
            </a>
            <a href="#" class="quick-action-btn" onclick="toggleDarkMode()">
                <i class="fas fa-moon me-2"></i>Dark Mode
            </a>
            <hr class="my-2">
            <small class="text-muted">Press 'Q' to toggle</small>
        </div>

        <!-- Sync Indicator -->
        <div id="syncIndicator" class="sync-indicator">
            <div class="loading-spinner me-2"></div>Syncing with Google Sheets...
        </div>
    
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel">
        <div><strong>Debug Panel</strong></div>
        <div id="debugContent"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Malaysia Time Helper Functions
        function getMalaysiaTime() {
            const now = new Date();
            const malaysiaTime = new Date(now.getTime() + (8 * 60 * 60 * 1000) + (now.getTimezoneOffset() * 60 * 1000));
            return malaysiaTime;
        }
        function formatMalaysiaDateTime(date) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'Asia/Kuala_Lumpur'
            };
            return new Date(date).toLocaleString('en-MY', options);
        }
        function formatMalaysiaDate(date) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'Asia/Kuala_Lumpur'
            };
            return new Date(date).toLocaleDateString('en-MY', options);
        }
        
        // Application State
        let currentUser = null;
        let currentEntryId = null;
        let currentRemarksEntryId = null;
        let showingDeleted = false;
        let isOnline = navigator.onLine;
        let debugMode = false;
        let syncInterval = null;
        let sessionTimeout = null;
        let sessionTimeLeft = 300; // 5 minutes in seconds
        
        // Google Sheets Integration
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbwe84Ec0M5f_0S2QwPWwIrNeGYblfk0AfacEGLTQdRsoRRuP1kXnqrpGXGUrLzyvuyX/exec";
        
        // Data Storage
        let users = [
            { id: '7434', name: 'Danial Danish', role: 'admin', password: 'Danial05', canCommit: true },
            { id: '4545', name: 'Ain Ismail', role: 'TL', password: 'Ain123', canCommit: true },
            { id: '5546', name: 'Cindamani Anam', role: 'RSE', password: 'Ann123', canCommit: true },
            { id: '7701', name: 'Syarifuddin Mat Razali', role: 'RSA', password: 'Din123', canCommit: false },
            { id: '7407', name: 'Nur Sabrina', role: 'RSA', password: 'Sab123', canCommit: false },
            { id: '7940', name: 'Eisya Nasir', role: 'RSA', password: 'Eisya123', canCommit: false },
            { id: '6435', name: 'Lee Shean Yi', role: 'RSA', password: 'Lee123', canCommit: false },
            { id: '0690', name: 'Kavindhran', role: 'AH', password: 'Kavin123', canCommit: true }
        ];
        
        let logbookEntries = [];
        let deletedEntries = [];
        let editRequests = [];
        let activityLogs = [];
        let entryRemarks = {};
        let lastSyncTime = null;
        
        // Debug function
        function debugLog(message) {
            if (debugMode) {
                console.log(message);
                const debugContent = document.getElementById('debugContent');
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('show', debugMode);
            if (debugMode) {
                debugLog('Debug mode enabled');
                debugLog('Current user: ' + (currentUser ? currentUser.name : 'None'));
                debugLog('Logbook entries: ' + logbookEntries.length);
                debugLog('Edit requests: ' + editRequests.length);
            }
        }
        
        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkLoginStatus();
            
            // Monitor online/offline status
            window.addEventListener('online', () => {
                isOnline = true;
                showSuccessMessage('You are back online!');
                syncWithGoogleSheets();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
            });
            
            // Set up real-time sync interval
            setupRealTimeSync();
            
            // Set up session timeout
            setupSessionTimeout();
        });
        
        // Session timeout management
        function setupSessionTimeout() {
            // Update session timer display
            updateSessionTimerDisplay();
            
            // Set up interval to update session timer every second
            setInterval(() => {
                if (currentUser) {
                    sessionTimeLeft--;
                    updateSessionTimerDisplay();
                    
                    if (sessionTimeLeft <= 0) {
                        logout();
                    }
                }
            }, 1000);
            
            // Reset session timeout on user activity
            document.addEventListener('mousemove', resetSessionTimeout);
            document.addEventListener('keypress', resetSessionTimeout);
            document.addEventListener('click', resetSessionTimeout);
            document.addEventListener('scroll', resetSessionTimeout);
        }
        
        function updateSessionTimerDisplay() {
            const minutes = Math.floor(sessionTimeLeft / 60);
            const seconds = sessionTimeLeft % 60;
            const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            const sessionTimer = document.getElementById('sessionTimer');
            const sessionTimeLeftElement = document.getElementById('sessionTimeLeft');
            
            if (currentUser) {
                sessionTimer.classList.add('show');
                sessionTimeLeftElement.textContent = timeString;
            } else {
                sessionTimer.classList.remove('show');
            }
        }
        
        function resetSessionTimeout() {
            if (currentUser) {
                sessionTimeLeft = 300; // Reset to 5 minutes
                debugLog('Session timeout reset');
            }
        }
        
        // Setup real-time synchronization
        function setupRealTimeSync() {
            // Clear any existing interval
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // Sync every 30 seconds when online
            syncInterval = setInterval(() => {
                if (isOnline && currentUser) {
                    performRealTimeSync();
                }
            }, 30000);
            
            // Also sync when page becomes visible again
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && isOnline && currentUser) {
                    performRealTimeSync();
                }
            });
        }
        
        // Perform real-time sync for edit requests and critical data
        function performRealTimeSync() {
            if (!currentUser || !isOnline) return;
            
            debugLog('Performing real-time sync...');
            showRealTimeIndicator();
            
            fetch(GOOGLE_SHEETS_URL + '?action=sync_requests&timestamp=' + Date.now())
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    const serverRequests = data.editRequests || [];
                    const serverEntries = data.entries || [];
                    
                    // Check for new edit requests
                    const localRequestIds = editRequests.map(r => r.id);
                    const newRequests = serverRequests.filter(r => !localRequestIds.includes(r.id));
                    
                    if (newRequests.length > 0) {
                        debugLog('Found ' + newRequests.length + ' new edit requests');
                        // Add new requests to local storage
                        newRequests.forEach(request => {
                            editRequests.unshift(request);
                        });
                        updateUI();
                        
                        // Show notification for admin users
                        if (currentUser.role === 'admin') {
                            showSuccessMessage('New edit request received!');
                        }
                    }
                    
                    // Check for resolved requests
                    const resolvedRequests = editRequests.filter(localReq => {
                        const serverReq = serverRequests.find(r => r.id === localReq.id);
                        return serverReq && serverReq.resolved && !localReq.resolved;
                    });
                    
                    if (resolvedRequests.length > 0) {
                        debugLog('Found ' + resolvedRequests.length + ' resolved requests');
                        // Update local requests
                        resolvedRequests.forEach(localReq => {
                            const serverReq = serverRequests.find(r => r.id === localReq.id);
                            if (serverReq) {
                                localReq.resolved = serverReq.resolved;
                                localReq.resolvedBy = serverReq.resolvedBy;
                                localReq.resolvedAt = serverReq.resolvedAt;
                                localReq.status = serverReq.status;
                            }
                        });
                        updateUI();
                        
                        // Show notification for requesters
                        resolvedRequests.forEach(req => {
                            if (req.requestedBy === currentUser.id) {
                                showSuccessMessage('Your edit request has been ' + (req.status || 'processed'));
                            }
                        });
                    }
                    
                    // Check for updated entries (especially uncommitted ones)
                    const updatedEntries = serverEntries.filter(serverEntry => {
                        const localEntry = logbookEntries.find(e => e.id === serverEntry.id);
                        return localEntry && localEntry.committed !== serverEntry.committed;
                    });
                    
                    if (updatedEntries.length > 0) {
                        debugLog('Found ' + updatedEntries.length + ' updated entries');
                        updatedEntries.forEach(serverEntry => {
                            const localEntry = logbookEntries.find(e => e.id === serverEntry.id);
                            if (localEntry) {
                                localEntry.committed = serverEntry.committed;
                                if (serverEntry.committed) {
                                    localEntry.committedBy = serverEntry.committedBy;
                                    localEntry.committedAt = serverEntry.committedAt;
                                } else {
                                    delete localEntry.committedBy;
                                    delete localEntry.committedAt;
                                }
                            }
                        });
                        updateUI();
                    }
                    
                    hideRealTimeIndicator();
                    saveToLocalStorage();
                } else {
                    debugLog('Real-time sync failed: ' + data.error);
                    hideRealTimeIndicator();
                }
            })
            .catch(error => {
                debugLog('Real-time sync error: ' + error.message);
                hideRealTimeIndicator();
            });
        }
        
        // Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('entryPhoto').addEventListener('change', handlePhotoPreview);
        }
        
        // Login Management
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('vmCourierUser');
            
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const user = users.find(u => u.id === userData.id);
                if (user) {
                    loginUser(user);
                    return;
                }
            }
            
            showLoginPage();
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            debugLog('Login attempt with ID: ' + id);
            console.log('Available users:', users.map(u => ({id: u.id, name: u.name})));
            
            const user = users.find(u => u.id === id && u.password === password);
            
            if (user) {
                // Always save user to localStorage
                localStorage.setItem('vmCourierUser', JSON.stringify({id: user.id}));
                loginUser(user);
            } else {
                showLoginError('Invalid ID or password. Please check your credentials.');
                console.log('Login failed - no matching user found');
            }
        }
        
        function loginUser(user) {
            currentUser = user;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Reset session timeout
            resetSessionTimeout();
            
            // Update UI
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0);
            
            // Show admin features
            if (user.role === 'admin') {
                document.getElementById('viewDeletedBtn').style.display = 'inline-block';
                document.getElementById('activityLogSection').style.display = 'block';
                document.getElementById('adminApprovalsLink').style.display = 'block';
            }
            
            // Set up real-time sync
            setupRealTimeSync();
            
            // Load data from Google Sheets
            loadDataFromGoogleSheets();
            
            logActivity('Login', `${user.name} logged in`);
            debugLog('User logged in: ' + user.name);
        }
        
        function logout() {
            if (currentUser) {
                logActivity('Logout', `${currentUser.name} logged out`);
                debugLog('User logged out: ' + currentUser.name);
            }
            
            // Clear sync interval
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            currentUser = null;
            localStorage.removeItem('vmCourierUser');
            showLoginPage();
        }
        
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
        }
        
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Page Navigation with Animation
        function showPage(page) {
            // Hide all pages with animation
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page with animation
            setTimeout(() => {
                document.getElementById(page + 'Page').classList.add('active');
            }, 100);
            
            // Set active nav link
            if (page === 'adminApprovals') {
                document.getElementById('adminApprovalsLink').classList.add('active');
            }
            
            // Load page content
            if (page === 'logbook') {
                loadLogbookPage();
            } else if (page === 'users') {
                loadUsersPage();
            } else if (page === 'adminApprovals') {
                loadAdminApprovalsPage();
            }
            
            // Perform real-time sync when switching pages
            if (isOnline && currentUser) {
                setTimeout(() => performRealTimeSync(), 500);
            }
        }
        
        // Logbook Management
        function loadLogbookPage() {
            updateStats();
            renderLogbookEntries();
            updateEditRequestBadge();
        }
        
        function updateStats() {
            const total = logbookEntries.length;
            const committed = logbookEntries.filter(e => e.committed).length;
            const myEntries = logbookEntries.filter(e => e.createdBy === currentUser.id).length;
            const requests = editRequests.filter(r => !r.resolved).length;
            
            document.getElementById('totalEntries').textContent = total;
            document.getElementById('committedEntries').textContent = committed;
            document.getElementById('myEntries').textContent = myEntries;
            document.getElementById('pendingRequests').textContent = requests;
        }
        
        function renderLogbookEntries() {
            const tbody = document.getElementById('entriesTableBody');
            tbody.innerHTML = '';
            
            const entriesToShow = showingDeleted ? deletedEntries : logbookEntries;
            let filteredEntries = entriesToShow;
            
            document.getElementById('entriesTitle').textContent = showingDeleted ? 
                'Deleted Entries' : 'All Entries';
            
            displayEntries(filteredEntries);
        }

        function displayEntries(entries = logbookEntries) {
            const tbody = document.getElementById('entriesTableBody');
            tbody.innerHTML = '';
            
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">No entries found.</td></tr>';
                return;
            }

            // Add loading shimmer effect
            tbody.innerHTML = '<tr><td colspan="12" class="loading-shimmer" style="height: 50px;"></td></tr>';
            
            // Simulate loading delay for better UX
            setTimeout(() => {
                tbody.innerHTML = '';
                renderEntries(entries);
            }, 300);
        }

        function renderEntries(entries) {
            const tbody = document.getElementById('entriesTableBody');
            
            entries.forEach(entry => {
                const row = document.createElement('tr');
                if (entry.committed) {
                    row.classList.add('committed-entry');
                }
                
                const hasEditRequest = editRequests.some(r => r.entryId === entry.id && !r.resolved);
                const editRequestBadge = hasEditRequest ? 
                    '<span class="edit-request-badge ms-2">Edit Requested</span>' : '';
                
                let statusBadge = '';
                if (entry.status) {
                    let statusClass = '';
                    switch(entry.status) {
                        case 'Pending':
                            statusClass = 'status-pending';
                            break;
                        case 'In transit':
                            statusClass = 'status-in-transit';
                            break;
                        case 'Delivered':
                            statusClass = 'status-delivered';
                            break;
                        case 'Return':
                            statusClass = 'status-return';
                            break;
                    }
                    statusBadge = `<span class="status-badge ${statusClass}">${entry.status}</span>`;
                }
                
                row.innerHTML = `
                    <td><span class="entry-id">${entry.id}</span></td>
                    <td>${formatMalaysiaDate(entry.date)}</td>
                    <td>${entry.pic}${editRequestBadge}</td>
                    <td><span class="badge bg-primary">${entry.destination}</span></td>
                    <td><span class="text-muted">${entry.cashbill || 'N/A'}</span></td>
                    <td><span class="text-muted">${entry.consignment || 'N/A'}</span></td>
                    <td>${entry.courierType || 'N/A'}</td>
                    <td>${statusBadge || '<span class="text-muted">Not set</span>'}</td>
                    <td>
                        ${entry.photo ? 
                            `<img src="${entry.photo}" class="entry-photo" onclick="viewPhoto('${entry.photo}')">` : 
                            '<span class="text-muted">No photo</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewRemarks('${entry.id}')">
                            <i class="fas fa-comment"></i> 
                            ${entryRemarks[entry.id] ? entryRemarks[entry.id].length : 0}
                        </button>
                    </td>
                    <td>
                        ${entry.committed ? 
                            '<span class="badge bg-success"><i class="fas fa-lock"></i> Committed</span>' : 
                            '<span class="badge bg-warning text-dark"><i class="fas fa-unlock"></i> Draft</span>'
                        }
                    </td>
                    <td>${renderActionButtons(entry)}</td>
                `;
                
                tbody.appendChild(row);
            });

        
        function renderActionButtons(entry) {
            debugLog('Rendering action buttons for entry:', entry);
            debugLog('Current user:', currentUser);
            debugLog('Entry committed:', entry.committed);
            debugLog('Entry PIC:', entry.pic);
            debugLog('Current user name:', currentUser.name);
            
            if (showingDeleted) {
                return currentUser.role === 'admin' ? `
                    <button class="btn btn-sm btn-success me-1" onclick="restoreEntry('${entry.id}')">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="permanentlyDeleteEntry('${entry.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
            }
            
            let buttons = '';
            const isCreator = entry.createdBy === currentUser.id;
            const isPIC = entry.pic === currentUser.name;
            
            // Edit button logic
            if (entry.committed) {
                // Committed entries - only admin can edit
                if (currentUser.role === 'admin') {
                    debugLog('Showing edit button for admin on committed entry');
                    buttons += `<button class="btn btn-sm btn-primary me-1" onclick="editEntry('${entry.id}')">
                        <i class="fas fa-edit"></i>
                    </button>`;
                } else {
                    debugLog('Showing admin contact button for non-admin on committed entry');
                    buttons += `<button class="btn btn-sm admin-contact-btn me-1" onclick="showAdminContact()">
                        <i class="fas fa-edit"></i> Edit
                    </button>`;
                }
            } else {
                // Uncommitted entries - creator, PIC, or admin can edit
                if (currentUser.role === 'admin' || isCreator || isPIC) {
                    debugLog('Showing edit button for uncommitted entry - user has permission');
                    buttons += `<button class="btn btn-sm btn-primary me-1" onclick="editEntry('${entry.id}')">
                        <i class="fas fa-edit"></i>
                    </button>`;
                } else {
                    debugLog('Not showing edit button for uncommitted entry - user does not have permission');
                }
            }
            
            // Delete button
            if (currentUser.role === 'admin' || 
                (isCreator && !entry.committed)) {
                buttons += `<button class="btn btn-sm btn-danger me-1" onclick="deleteEntry('${entry.id}')">
                    <i class="fas fa-trash"></i>
                </button>`;
            }
            
            // Commit/Uncommit button - UPDATED LOGIC
            if (!entry.committed) {
                // Allow commit if:
                // 1. User is the creator of the entry, OR
                // 2. User is admin, OR
                // 3. User has canCommit permission AND is NOT the creator
                if (isCreator || currentUser.role === 'admin' || 
                    (currentUser.canCommit && !isCreator)) {
                    buttons += `<button class="btn btn-sm btn-success" onclick="commitEntry('${entry.id}')">
                        <i class="fas fa-lock"></i> Commit
                    </button>`;
                }
            } else if (currentUser.role === 'admin') {
                // Only admin can uncommit
                buttons += `<button class="btn btn-sm btn-secondary" onclick="uncommitEntry('${entry.id}')">
                    <i class="fas fa-unlock"></i>
                </button>`;
            }
            
            debugLog('Buttons HTML:', buttons);
            return buttons;
        }
        
        // Generate LBVM sequential ID starting from LBVM001
        function generateNextId() {
            try {
                debugLog('Generating next ID...');
                
                const allEntries = [...logbookEntries, ...deletedEntries];
                debugLog('Total entries found: ' + allEntries.length);
                
                const lbvmEntries = allEntries.filter(entry => entry.id && entry.id.startsWith('LBVM'));
                debugLog('LBVM entries found: ' + lbvmEntries.length);
                
                if (lbvmEntries.length === 0) {
                    debugLog('No LBVM entries found, starting with LBVM001');
                    return "LBVM001";
                }
                
                let maxNum = 0;
                lbvmEntries.forEach(entry => {
                    const numStr = entry.id.substring(4);
                    const num = parseInt(numStr, 10);
                    if (!isNaN(num) && num > maxNum) {
                        maxNum = num;
                    }
                });
                
                debugLog('Max number found: ' + maxNum);
                
                const nextNum = maxNum + 1;
                const nextNumStr = String(nextNum).padStart(3, '0');
                const newId = `LBVM${nextNumStr}`;
                
                debugLog('Generated new ID: ' + newId);
                return newId;
            } catch (error) {
                debugLog('Error generating ID: ' + error.message);
                return "LBVM" + Date.now();
            }
        }
        
        // Entry Management
        function openAddEntryModal() {
            currentEntryId = null;
            document.getElementById('entryModalTitle').textContent = 'Add New Entry';
            document.getElementById('entryForm').reset();
            
            const malaysiaDate = getMalaysiaTime();
            document.getElementById('entryDate').value = malaysiaDate.toISOString().split('T')[0];
            
            document.getElementById('entryPIC').value = currentUser.name;
            document.getElementById('entryCashbill').value = '';
            document.getElementById('entryConsignment').value = '';
            document.getElementById('entryCourierType').value = '';
            document.getElementById('entryStatus').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('saveButtonText').textContent = 'Save Entry';
            debugLog('Opened add entry modal');
        }
        
        function saveEntry() {
            debugLog('Save entry called');
            
            const date = document.getElementById('entryDate').value;
            const destination = document.getElementById('entryDestination').value;
            const cashbill = document.getElementById('entryCashbill').value;
            const consignment = document.getElementById('entryConsignment').value;
            const courierType = document.getElementById('entryCourierType').value;
            const status = document.getElementById('entryStatus').value;
            const photoFile = document.getElementById('entryPhoto').files[0];
            const remarks = document.getElementById('entryRemarks').value;
            
            debugLog('Form data:', { date, destination, cashbill, consignment, courierType, status, remarks, hasPhoto: !!photoFile });
            
            if (!date || !destination || !cashbill || !consignment || !courierType || !status) {
                debugLog('Validation failed - missing required fields');
                alert('Please fill in all required fields');
                return;
            }
            
            let photoData = null;
            if (photoFile) {
                debugLog('Processing photo file...');
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                    debugLog('Photo loaded, size: ' + photoData.length);
                    saveEntryWithPhoto(date, destination, cashbill, consignment, courierType, status, remarks, photoData);
                };
                reader.readAsDataURL(photoFile);
            } else {
                debugLog('No photo file, proceeding without photo');
                saveEntryWithPhoto(date, destination, cashbill, consignment, courierType, status, remarks, null);
            }
        }
        
        function saveEntryWithPhoto(date, destination, cashbill, consignment, courierType, status, remarks, photoData) {
            try {
                debugLog('Saving entry with photo:', { date, destination, cashbill, consignment, courierType, status, hasPhoto: !!photoData });
                
                if (currentEntryId) {
                    // Edit existing entry
                    debugLog('Editing existing entry: ' + currentEntryId);
                    const entry = logbookEntries.find(e => e.id === currentEntryId);
                    if (entry) {
                        entry.date = date;
                        entry.destination = destination;
                        entry.cashbill = cashbill;
                        entry.consignment = consignment;
                        entry.courierType = courierType;
                        entry.status = status;
                        if (photoData) entry.photo = photoData;
                        entry.lastModified = getMalaysiaTime().toISOString();
                        
                        if (remarks) {
                            if (!entryRemarks[currentEntryId]) entryRemarks[currentEntryId] = [];
                            entryRemarks[currentEntryId].push({
                                text: remarks,
                                author: currentUser.name,
                                timestamp: getMalaysiaTime().toISOString()
                            });
                        }
                        
                        logActivity('Edit Entry', `Entry #${currentEntryId} edited by ${currentUser.name}`);
                        
                        if (isOnline) {
                            updateGoogleSheet(entry);
                        } else {
                            showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                        }
                    } else {
                        debugLog('Error: Entry not found for editing: ' + currentEntryId);
                        alert('Error: Entry not found');
                        return;
                    }
                } else {
                    // Add new entry with LBVM sequential ID
                    debugLog('Creating new entry...');
                    const newId = generateNextId();
                    debugLog('Generated new ID: ' + newId);
                    
                    const malaysiaTime = getMalaysiaTime();
                    
                    const newEntry = {
                        id: newId,
                        date: date,
                        pic: currentUser.name,
                        destination: destination,
                        cashbill: cashbill,
                        consignment: consignment,
                        courierType: courierType,
                        status: status,
                        photo: photoData,
                        committed: false,
                        createdBy: currentUser.id,
                        createdAt: malaysiaTime.toISOString(),
                        lastModified: malaysiaTime.toISOString()
                    };
                    
                    debugLog('Created new entry:', newEntry);
                    
                    logbookEntries.unshift(newEntry);
                    debugLog('Added entry to logbookEntries. Total entries: ' + logbookEntries.length);
                    
                    if (remarks) {
                        entryRemarks[newEntry.id] = [{
                            text: remarks,
                            author: currentUser.name,
                            timestamp: malaysiaTime.toISOString()
                        }];
                    }
                    
                    logActivity('Add Entry', `New entry created by ${currentUser.name}`);
                    
                    if (isOnline) {
                        debugLog('Submitting to Google Sheets...');
                        submitToGoogleSheet(newEntry);
                        showSuccessMessage('Entry created successfully and submitted to Google Sheets!');
                    } else {
                        debugLog('Offline mode - saving locally only');
                        showErrorMessage('You are offline. Entry saved locally and will be synced when you reconnect.');
                    }
                }
                
                debugLog('Saving to localStorage...');
                saveToLocalStorage();
                debugLog('Updating UI...');
                updateUI();
                debugLog('Closing modal...');
                bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
                debugLog('Entry saved successfully');
            } catch (error) {
                debugLog('Error saving entry: ' + error.message);
                console.error('Error saving entry:', error);
                alert('Error saving entry: ' + error.message);
            }
        }
        
        function editEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            currentEntryId = entryId;
            document.getElementById('entryModalTitle').textContent = 'Edit Entry';
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryPIC').value = entry.pic;
            document.getElementById('entryDestination').value = entry.destination;
            document.getElementById('entryCashbill').value = entry.cashbill || '';
            document.getElementById('entryConsignment').value = entry.consignment || '';
            document.getElementById('entryCourierType').value = entry.courierType || '';
            document.getElementById('entryStatus').value = entry.status || '';
            document.getElementById('entryRemarks').value = '';
            document.getElementById('saveButtonText').textContent = 'Update Entry';
            
            if (entry.photo) {
                document.getElementById('photoPreview').innerHTML = `
                    <img src="${entry.photo}" class="photo-preview">
                `;
            }
            
            new bootstrap.Modal(document.getElementById('entryModal')).show();
        }
        
        function deleteEntry(entryId) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            
            const entryIndex = logbookEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = logbookEntries.splice(entryIndex, 1)[0];
                deletedEntries.unshift(entry);
                logActivity('Delete Entry', `Entry #${entryId} deleted by ${currentUser.name}`);
                
                if (isOnline) {
                    deleteFromGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
            }
        }
        
        function commitEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            // Allow commit if:
            // 1. User is the creator of the entry, OR
            // 2. User is admin, OR
            // 3. User has canCommit permission AND is NOT the creator
            const isCreator = entry.createdBy === currentUser.id;
            
            if (!isCreator && currentUser.role !== 'admin' && !currentUser.canCommit) {
                showErrorMessage('You do not have permission to commit this entry.');
                return;
            }
            
            // Validate required fields before committing
            if (!entry.date || !entry.destination || !entry.cashbill || !entry.consignment || !entry.courierType || !entry.status) {
                showErrorMessage('Please fill in all required fields before committing.');
                return;
            }
            
            entry.committed = true;
            entry.committedBy = currentUser.id;
            entry.committedAt = getMalaysiaTime().toISOString();
            
            // Remove uncommit tracking if exists
            delete entry.uncommittedBy;
            delete entry.uncommittedAt;
            
            // Add system remark if this is a re-commit after uncommit
            if (entry.lastCommittedBy) {
                if (!entryRemarks[entryId]) {
                    entryRemarks[entryId] = [];
                }
                entryRemarks[entryId].push({
                    text: `Entry re-committed by ${currentUser.name}.`,
                    author: 'System',
                    timestamp: getMalaysiaTime().toISOString(),
                    isSystem: true
                });
            }
            
            entry.lastCommittedBy = currentUser.id;
            entry.lastCommittedAt = getMalaysiaTime().toISOString();
            
            logActivity('Commit Entry', `Entry #${entryId} committed by ${currentUser.name}`);
            
            if (isOnline) {
                updateGoogleSheet(entry);
            } else {
                showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
            }
            
            saveToLocalStorage();
            updateUI();
            
            if (entry.lastCommittedBy && entry.lastCommittedBy !== currentUser.id) {
                showSuccessMessage('Entry re-committed successfully!');
            } else {
                showSuccessMessage('Entry committed successfully!');
            }
        }
        
        function uncommitEntry(entryId) {
            // Only admin can uncommit entries
            if (currentUser.role !== 'admin') {
                showErrorMessage('Only administrators can uncommit entries. Please contact Danial Danish (ID: 7434).');
                return;
            }
            
            const entry = logbookEntries.find(e => e.id === entryId);
            if (entry) {
                entry.committed = false;
                entry.uncommittedBy = currentUser.id;
                entry.uncommittedAt = getMalaysiaTime().toISOString();
                delete entry.committedBy;
                delete entry.committedAt;
                
                // Notify the creator that their entry has been uncommitted
                const creator = users.find(u => u.id === entry.createdBy);
                if (creator && creator.id !== currentUser.id) {
                    // Add a system remark to notify the creator
                    if (!entryRemarks[entryId]) {
                        entryRemarks[entryId] = [];
                    }
                    entryRemarks[entryId].push({
                        text: `Admin has uncommitted this entry. You can now edit and re-commit it.`,
                        author: 'System',
                        timestamp: getMalaysiaTime().toISOString(),
                        isSystem: true
                    });
                }
                
                // Resolve any edit requests for this entry
                editRequests.forEach(req => {
                    if (req.entryId === entryId) {
                        req.resolved = true;
                        req.resolvedBy = currentUser.id;
                        req.resolvedAt = getMalaysiaTime().toISOString();
                    }
                });
                
                logActivity('Uncommit Entry', `Entry #${entryId} uncommitted by admin ${currentUser.name}`);
                
                // Force immediate sync to ensure all devices see the change
                if (isOnline) {
                    updateGoogleSheet(entry);
                    // Force a refresh of data from Google Sheets
                    setTimeout(() => {
                        loadDataFromGoogleSheets();
                    }, 1000);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
                showSuccessMessage('Entry uncommitted successfully! The creator can now edit and re-commit this entry.');
            }
        }
        
        function adminCommitEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (entry) {
                entry.committed = true;
                entry.committedBy = currentUser.id;
                entry.committedAt = getMalaysiaTime().toISOString();
                entry.lastCommittedBy = currentUser.id;
                entry.lastCommittedAt = getMalaysiaTime().toISOString();
                
                // Remove uncommit tracking
                delete entry.uncommittedBy;
                delete entry.uncommittedAt;
                
                logActivity('Admin Commit', `Entry #${entryId} re-committed by admin ${currentUser.name}`);
                
                if (isOnline) {
                    updateGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
                showSuccessMessage('Entry re-committed successfully by admin!');
            }
        }
        
        function restoreEntry(entryId) {
            const entryIndex = deletedEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = deletedEntries.splice(entryIndex, 1)[0];
                logbookEntries.unshift(entry);
                logActivity('Restore Entry', `Entry #${entryId} restored by ${currentUser.name}`);
                
                if (isOnline) {
                    updateGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
            }
        }
        
        function permanentlyDeleteEntry(entryId) {
            if (!confirm('Are you sure you want to permanently delete this entry? This cannot be undone.')) return;
            
            const entryIndex = deletedEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = deletedEntries.splice(entryIndex, 1)[0];
                delete entryRemarks[entryId];
                logActivity('Permanent Delete', `Entry #${entryId} permanently deleted by ${currentUser.name}`);
                
                if (isOnline) {
                    deleteFromGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
            }
        }
        
        function toggleDeletedEntries() {
            showingDeleted = !showingDeleted;
            const btn = document.getElementById('viewDeletedBtn');
            btn.innerHTML = showingDeleted ? 
                '<i class="fas fa-list me-2"></i>View Active Entries' : 
                '<i class="fas fa-trash me-2"></i>View Deleted Entries';
            renderLogbookEntries();
        }
        
        // Admin Contact Modal
        function showAdminContact() {
            new bootstrap.Modal(document.getElementById('adminContactModal')).show();
        }
        
        // Remarks Management
        function viewRemarks(entryId) {
            currentRemarksEntryId = entryId;
            const remarks = entryRemarks[entryId] || [];
            const remarksList = document.getElementById('remarksList');
            
            remarksList.innerHTML = '';
            if (remarks.length === 0) {
                remarksList.innerHTML = '<p class="text-muted">No remarks yet.</p>';
            } else {
                remarks.forEach(remark => {
                    const remarkDiv = document.createElement('div');
                    remarkDiv.className = 'remark-item';
                    if (remark.isSystem) {
                        remarkDiv.classList.add('system-remark');
                        remarkDiv.innerHTML = `
                            <div class="remark-author">
                                <i class="fas fa-info-circle me-1"></i>${remark.author}
                            </div>
                            <div>${remark.text}</div>
                            <div class="remark-time">${formatMalaysiaDateTime(remark.timestamp)}</div>
                        `;
                    } else {
                        remarkDiv.innerHTML = `
                            <div class="remark-author">${remark.author}</div>
                            <div>${remark.text}</div>
                            <div class="remark-time">${formatMalaysiaDateTime(remark.timestamp)}</div>
                        `;
                    }
                    remarksList.appendChild(remarkDiv);
                });
            }
            
            document.getElementById('newRemark').value = '';
            new bootstrap.Modal(document.getElementById('remarksModal')).show();
        }
        
        function addRemark() {
            const remarkText = document.getElementById('newRemark').value.trim();
            if (!remarkText) return;
            
            if (!entryRemarks[currentRemarksEntryId]) {
                entryRemarks[currentRemarksEntryId] = [];
            }
            
            entryRemarks[currentRemarksEntryId].push({
                text: remarkText,
                author: currentUser.name,
                timestamp: getMalaysiaTime().toISOString()
            });
            
            logActivity('Add Remark', `Remark added to entry #${currentRemarksEntryId} by ${currentUser.name}`);
            saveToLocalStorage();
            viewRemarks(currentRemarksEntryId);
            renderLogbookEntries();
        }
        
        // Edit Request Management with Enhanced Sync
        function requestEdit(entryId) {
            debugLog('Requesting edit for entry:', entryId);
            currentEntryId = entryId;
            document.getElementById('editRequestReason').value = '';
            
            // Ensure the modal is properly initialized
            const modalElement = document.getElementById('editRequestModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        function submitEditRequest() {
            const reason = document.getElementById('editRequestReason').value.trim();
            if (!reason) {
                alert('Please provide a reason for the edit request');
                return;
            }
            
            const request = {
                id: Date.now(),
                entryId: currentEntryId,
                requestedBy: currentUser.id,
                requestedByName: currentUser.name,
                reason: reason,
                timestamp: getMalaysiaTime().toISOString(),
                resolved: false
            };
            
            editRequests.unshift(request);
            logActivity('Edit Request', `Edit request submitted for entry #${currentEntryId} by ${currentUser.name}`);
            
            // Save locally first
            saveToLocalStorage();
            updateUI();
            
            // Sync with Google Sheets immediately
            if (isOnline) {
                syncEditRequestToGoogleSheets(request)
                    .then(() => {
                        showSuccessMessage('Edit request submitted and synced successfully!');
                    })
                    .catch(error => {
                        debugLog('Failed to sync edit request: ' + error.message);
                        showErrorMessage('Edit request submitted locally. Will sync when online.');
                    });
            } else {
                showSuccessMessage('Edit request submitted. Will sync when online.');
            }
            
            bootstrap.Modal.getInstance(document.getElementById('editRequestModal')).hide();
        }
        
        // Sync edit request to Google Sheets
        async function syncEditRequestToGoogleSheets(request) {
            const formData = new FormData();
            formData.append('action', 'sync_edit_request');
            formData.append('requestId', request.id);
            formData.append('entryId', request.entryId);
            formData.append('requestedBy', request.requestedBy);
            formData.append('requestedByName', request.requestedByName);
            formData.append('reason', request.reason);
            formData.append('timestamp', request.timestamp);
            formData.append('resolved', request.resolved);
            
            const response = await fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (data.result !== 'success') {
                throw new Error(data.error || 'Failed to sync edit request');
            }
            
            return data;
        }
        
        function updateEditRequestBadge() {
            const pendingRequests = editRequests.filter(r => !r.resolved).length;
            const badge = document.getElementById('editRequestBadge');
            
            if (currentUser.role === 'admin' && pendingRequests > 0) {
                badge.textContent = pendingRequests;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // User Management
        function loadUsersPage() {
            const usersList = document.getElementById('usersList');
            const usersTitle = document.getElementById('usersTitle');
            
            if (currentUser.role === 'admin') {
                usersTitle.textContent = 'All Users';
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'card mb-3';
                    userCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <div class="user-avatar mx-auto">${user.name.charAt(0)}</div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-1">${user.name}</h6>
                                    <p class="mb-1">ID: ${user.id}</p>
                                    <span class="badge ${user.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${user.role}</span>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="commit${user.id}" 
                                               ${user.canCommit ? 'checked' : ''} 
                                               onchange="toggleCommitPermission('${user.id}')"
                                               ${user.role === 'admin' ? 'disabled' : ''}>
                                        <label class="form-check-label" for="commit${user.id}">
                                            Can Commit Others' Entries
                                            <div class="permission-info">Everyone can commit their own entries</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    usersList.appendChild(userCard);
                });
                
                loadActivityLog();
            } else {
                usersTitle.textContent = 'My Profile';
                usersList.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <div class="user-avatar mx-auto" style="width: 80px; height: 80px; font-size: 2rem;">
                                        ${currentUser.name.charAt(0)}
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <h4>${currentUser.name}</h4>
                                    <p class="mb-1"><strong>ID:</strong> ${currentUser.id}</p>
                                    <p class="mb-1"><strong>Role:</strong> 
                                        <span class="badge ${currentUser.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${currentUser.role}</span>
                                    </p>
                                    <p class="mb-1"><strong>Outlet:</strong> VM:Switch VillageMall</p>
                                    <p class="mb-0"><strong>Can Commit Others' Entries:</strong> 
                                        <span class="badge ${currentUser.canCommit ? 'bg-success' : 'bg-danger'}">
                                            ${currentUser.canCommit ? 'Yes' : 'No'}
                                        </span>
                                        <div class="permission-info d-inline-block ms-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            You can always commit your own entries
                                        </div>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function toggleCommitPermission(userId) {
            const user = users.find(u => u.id === userId);
            if (user && user.role !== 'admin') {
                user.canCommit = !user.canCommit;
                logActivity('Toggle Permission', `Commit permission ${user.canCommit ? 'granted to' : 'revoked from'} ${user.name}`);
                saveToLocalStorage();
            }
        }
        
        function loadActivityLog() {
            const activityLog = document.getElementById('activityLog');
            activityLog.innerHTML = '';
            
            // Show edit requests first
            const pendingRequests = editRequests.filter(r => !r.resolved);
            if (pendingRequests.length > 0) {
                const requestsHeader = document.createElement('h6');
                requestsHeader.className = 'text-warning mb-3';
                requestsHeader.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Pending Edit Requests';
                activityLog.appendChild(requestsHeader);
                
                pendingRequests.forEach(request => {
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'activity-item bg-warning bg-opacity-10 border border-warning';
                    requestDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${request.requestedByName}</strong> requests edit for Entry #${request.entryId}
                                <br><small class="text-muted">${formatMalaysiaDateTime(request.timestamp)}</small>
                                <br><em>"${request.reason}"</em>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="approveEditRequest(${request.id})">
                                Approve
                            </button>
                        </div>
                    `;
                    activityLog.appendChild(requestDiv);
                });
            }
            
            // Show entries awaiting admin re-commit approval
            const uncommittedEntries = logbookEntries.filter(e => !e.committed && e.uncommittedBy);
            if (uncommittedEntries.length > 0) {
                const uncommittedHeader = document.createElement('h6');
                uncommittedHeader.className = 'text-info mb-3';
                uncommittedHeader.innerHTML = '<i class="fas fa-clock me-2"></i>Entries Awaiting Re-commit Approval';
                activityLog.appendChild(uncommittedHeader);
                
                uncommittedEntries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'activity-item bg-info bg-opacity-10 border border-info';
                    entryDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>Entry #${entry.id}</strong> is uncommitted and awaiting re-commit
                                <br><small class="text-muted">Created by: ${entry.pic}</small>
                                <br><small class="text-muted">Uncommitted by: ${users.find(u => u.id === entry.uncommittedBy)?.name || 'Unknown'}</small>
                                <br><small class="text-muted">Uncommitted at: ${formatMalaysiaDateTime(entry.uncommittedAt)}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-1" onclick="adminCommitEntry('${entry.id}')">
                                    <i class="fas fa-check"></i> Approve Commit
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="viewEntryDetails('${entry.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                    `;
                    activityLog.appendChild(entryDiv);
                });
            }
            
            // Show recent activity
            const recentLogs = activityLogs.slice(0, 10);
            if (recentLogs.length > 0) {
                const logsHeader = document.createElement('h6');
                logsHeader.className = 'text-primary mb-3 mt-4';
                logsHeader.innerHTML = '<i class="fas fa-history me-2"></i>Recent Activity';
                activityLog.appendChild(logsHeader);
                
                recentLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = 'activity-item';
                    logDiv.innerHTML = `
                        <strong>${log.action}</strong>
                        <br><small class="text-muted">${log.details}</small>
                        <br><small class="text-muted">${formatMalaysiaDateTime(log.timestamp)}</small>
                    `;
                    activityLog.appendChild(logDiv);
                });
            }
        }
        
        function approveEditRequest(requestId) {
            const request = editRequests.find(r => r.id === requestId);
            if (request) {
                // Update the request status
                request.resolved = true;
                request.resolvedBy = currentUser.id;
                request.resolvedAt = getMalaysiaTime().toISOString();
                request.status = 'approved';
                
                // Sync the approval to Google Sheets
                if (isOnline) {
                    syncEditRequestToGoogleSheets(request)
                        .then(() => {
                            uncommitEntry(request.entryId);
                            showSuccessMessage(`Edit request approved and synced successfully!`);
                        })
                        .catch(error => {
                            debugLog('Failed to sync approval: ' + error.message);
                            uncommitEntry(request.entryId);
                            showErrorMessage('Edit request approved. Sync will happen when online.');
                        });
                } else {
                    uncommitEntry(request.entryId);
                    showSuccessMessage('Edit request approved. Will sync when online.');
                }
            }
        }
        
        function viewEntryDetails(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            const modalHtml = `
            <div class="modal fade" id="entryDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Entry Details - #${entry.id}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Date:</strong> ${formatMalaysiaDate(entry.date)}</p>
                                    <p><strong>PIC:</strong> ${entry.pic}</p>
                                    <p><strong>Destination:</strong> ${entry.destination}</p>
                                    <p><strong>Cashbill:</strong> ${entry.cashbill || 'N/A'}</p>
                                    <p><strong>Consignment:</strong> ${entry.consignment || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Courier Type:</strong> ${entry.courierType || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${entry.status || 'Not set'}</p>
                                    <p><strong>Created By:</strong> ${users.find(u => u.id === entry.createdBy)?.name || 'Unknown'}</p>
                                    <p><strong>Created At:</strong> ${formatMalaysiaDateTime(entry.createdAt)}</p>
                                    <p><strong>Last Modified:</strong> ${formatMalaysiaDateTime(entry.lastModified)}</p>
                                </div>
                            </div>
                            ${entry.photo ? `
                            <div class="mt-3">
                                <p><strong>Photo Proof:</strong></p>
                                <img src="${entry.photo}" class="img-fluid" style="max-height: 300px;">
                            </div>
                            ` : ''}
                            ${entryRemarks[entry.id] ? `
                            <div class="mt-3">
                                <p><strong>Remarks:</strong></p>
                                <div class="remarks-list">
                                    ${entryRemarks[entry.id].map(remark => `
                                        <div class="remark-item ${remark.isSystem ? 'system-remark' : ''}">
                                            <div class="remark-author">
                                                ${remark.isSystem ? '<i class="fas fa-info-circle me-1"></i>' : ''}${remark.author}
                                            </div>
                                            <div>${remark.text}</div>
                                            <div class="remark-time">${formatMalaysiaDateTime(remark.timestamp)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="adminCommitEntry('${entry.id}'); bootstrap.Modal.getInstance(document.getElementById('entryDetailsModal')).hide();">
                                <i class="fas fa-check"></i> Approve Commit
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            const existingModal = document.getElementById('entryDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('entryDetailsModal')).show();
        }
        
        // Admin Approvals Management
        function loadAdminApprovalsPage() {
            // Load edit requests
            const editRequestsList = document.getElementById('editRequestsList');
            const pendingRequests = editRequests.filter(r => !r.resolved);
            
            document.getElementById('editRequestsCount').textContent = pendingRequests.length;
            
            if (pendingRequests.length === 0) {
                editRequestsList.innerHTML = '<p class="text-muted">No pending edit requests.</p>';
            } else {
                editRequestsList.innerHTML = '';
                pendingRequests.forEach(request => {
                    const requestCard = document.createElement('div');
                    requestCard.className = 'card request-card mb-3';
                    requestCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="card-title">Edit Request for Entry #${request.entryId}</h6>
                                    <p class="mb-1"><strong>Requested by:</strong> ${request.requestedByName}</p>
                                    <p class="mb-1"><strong>Reason:</strong> ${request.reason}</p>
                                    <p class="text-muted mb-0"><small>${formatMalaysiaDateTime(request.timestamp)}</small></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-success me-2" onclick="approveEditRequest(${request.id})">
                                        <i class="fas fa-check me-1"></i>Approve
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectEditRequest(${request.id})">
                                        <i class="fas fa-times me-1"></i>Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    editRequestsList.appendChild(requestCard);
                });
            }
            
            // Load uncommitted entries
            const uncommittedEntriesList = document.getElementById('uncommittedEntriesList');
            const uncommittedEntries = logbookEntries.filter(e => !e.committed && e.uncommittedBy);
            
            document.getElementById('uncommittedCount').textContent = uncommittedEntries.length;
            
            if (uncommittedEntries.length === 0) {
                uncommittedEntriesList.innerHTML = '<p class="text-muted">No entries awaiting re-commit approval.</p>';
            } else {
                uncommittedEntriesList.innerHTML = '';
                uncommittedEntries.forEach(entry => {
                    const entryCard = document.createElement('div');
                    entryCard.className = 'card request-card mb-3';
                    entryCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="card-title">Entry #${entry.id}</h6>
                                    <p class="mb-1"><strong>PIC:</strong> ${entry.pic}</p>
                                    <p class="mb-1"><strong>Destination:</strong> ${entry.destination}</p>
                                    <p class="mb-1"><strong>Uncommitted by:</strong> ${users.find(u => u.id === entry.uncommittedBy)?.name || 'Unknown'}</p>
                                    <p class="text-muted mb-0"><small>Uncommitted at: ${formatMalaysiaDateTime(entry.uncommittedAt)}</small></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-success me-2" onclick="adminCommitEntry('${entry.id}')">
                                        <i class="fas fa-check me-1"></i>Approve Commit
                                    </button>
                                    <button class="btn btn-primary" onclick="viewEntryDetails('${entry.id}')">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    uncommittedEntriesList.appendChild(entryCard);
                });
            }
            
            updateAdminApprovalBadge();
        }
        
        function rejectEditRequest(requestId) {
            if (!confirm('Are you sure you want to reject this edit request?')) return;
            
            const request = editRequests.find(r => r.id === requestId);
            if (request) {
                // Update the request status
                request.resolved = true;
                request.resolvedBy = currentUser.id;
                request.resolvedAt = getMalaysiaTime().toISOString();
                request.status = 'rejected';
                
                // Sync the rejection to Google Sheets
                if (isOnline) {
                    syncEditRequestToGoogleSheets(request)
                        .then(() => {
                            logActivity('Reject Edit Request', `Edit request for entry #${request.entryId} rejected by ${currentUser.name}`);
                            saveToLocalStorage();
                            loadAdminApprovalsPage();
                            showSuccessMessage('Edit request rejected and synced successfully!');
                        })
                        .catch(error => {
                            debugLog('Failed to sync rejection: ' + error.message);
                            logActivity('Reject Edit Request', `Edit request for entry #${request.entryId} rejected by ${currentUser.name}`);
                            saveToLocalStorage();
                            loadAdminApprovalsPage();
                            showErrorMessage('Edit request rejected. Sync will happen when online.');
                        });
                } else {
                    logActivity('Reject Edit Request', `Edit request for entry #${request.entryId} rejected by ${currentUser.name}`);
                    saveToLocalStorage();
                    loadAdminApprovalsPage();
                    showSuccessMessage('Edit request rejected. Will sync when online.');
                }
            }
        }
        
        function updateAdminApprovalBadge() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const pendingRequests = editRequests.filter(r => !r.resolved).length;
            const uncommittedEntries = logbookEntries.filter(e => !e.committed && e.uncommittedBy).length;
            const total = pendingRequests + uncommittedEntries;
            
            const badge = document.getElementById('adminApprovalBadge');
            if (total > 0) {
                badge.textContent = total;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Utility Functions
        function handlePhotoPreview() {
            const file = document.getElementById('entryPhoto').files[0];
            const preview = document.getElementById('photoPreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        }
        
        function viewPhoto(photoSrc) {
            document.getElementById('modalPhoto').src = photoSrc;
            new bootstrap.Modal(document.getElementById('photoModal')).show();
        }
        
        function logActivity(action, details) {
            activityLogs.unshift({
                action: action,
                details: details,
                user: currentUser.name,
                userId: currentUser.id,
                timestamp: getMalaysiaTime().toISOString()
            });
            saveToLocalStorage();
        }
        
        function updateUI() {
            if (currentUser) {
                loadLogbookPage();
                if (document.getElementById('usersPage').classList.contains('active')) {
                    loadUsersPage();
                }
                if (document.getElementById('adminApprovalsPage').classList.contains('active')) {
                    loadAdminApprovalsPage();
                }
                if (currentUser.role === 'admin') {
                    updateAdminApprovalBadge();
                }
            }
        }
        
        // Force sync function
        function forceSync() {
            if (!currentUser) return;
            
            if (!isOnline) {
                showErrorMessage('You are offline. Cannot sync with Google Sheets.');
                return;
            }
            
            showSuccessMessage('Force sync initiated...');
            loadDataFromGoogleSheets();
        }
        
        // Google Sheets Integration Functions
        function submitToGoogleSheet(entryData) {
            debugLog('Submitting to Google Sheets:', entryData);
            showSyncIndicator();
            
            const formData = new FormData();
            formData.append('date', entryData.date || '');
            formData.append('pic', entryData.pic || '');
            formData.append('destination', entryData.destination || '');
            formData.append('cashbill', entryData.cashbill || '');
            formData.append('consignment', entryData.consignment || '');
            formData.append('courierType', entryData.courierType || '');
            formData.append('status', entryData.status || '');
            formData.append('id', entryData.id || '');
            formData.append('committed', entryData.committed);
            formData.append('createdBy', entryData.createdBy || '');
            formData.append('createdAt', entryData.createdAt || '');
            formData.append('lastModified', entryData.lastModified || '');
            formData.append('action', 'submit');
            
            fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                debugLog('Google Sheets response status:', response.status);
                return response.json();
            })
            .then(data => {
                debugLog('Google Sheets response data:', data);
                if (data.result === 'success') {
                    console.log('Data submitted to Google Sheets successfully');
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Entry created successfully and submitted to Google Sheets!');
                } else {
                    console.error('Error submitting to Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error submitting to Google Sheets: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error submitting to Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while submitting to Google Sheets');
            });
        }
        
        function updateGoogleSheet(entryData) {
            showSyncIndicator();
            
            const formData = new FormData();
            formData.append('date', entryData.date || '');
            formData.append('pic', entryData.pic || '');
            formData.append('destination', entryData.destination || '');
            formData.append('cashbill', entryData.cashbill || '');
            formData.append('consignment', entryData.consignment || '');
            formData.append('courierType', entryData.courierType || '');
            formData.append('status', entryData.status || '');
            formData.append('id', entryData.id || '');
            formData.append('committed', entryData.committed);
            formData.append('createdBy', entryData.createdBy || '');
            formData.append('createdAt', entryData.createdAt || '');
            formData.append('lastModified', entryData.lastModified || '');
            formData.append('action', 'update');
            
            // Add uncommit tracking if exists
            if (entryData.uncommittedBy) {
                formData.append('uncommittedBy', entryData.uncommittedBy);
                formData.append('uncommittedAt', entryData.uncommittedAt);
            }
            
            fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    console.log('Data updated in Google Sheets successfully');
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Entry updated in Google Sheets successfully!');
                } else {
                    console.error('Error updating Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error updating Google Sheets: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while updating Google Sheets');
            });
        }
        
        function deleteFromGoogleSheet(entryData) {
            showSyncIndicator();
            
            const formData = new FormData();
            formData.append('id', entryData.id || '');
            formData.append('action', 'delete');
            
            fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    console.log('Data deleted from Google Sheets successfully');
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Entry deleted from Google Sheets successfully!');
                } else {
                    console.error('Error deleting from Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error deleting from Google Sheets: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting from Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while deleting from Google Sheets');
            });
        }
        
        function loadDataFromGoogleSheets() {
            if (!isOnline) {
                loadFromLocalStorage();
                showErrorMessage('You are offline. Loading data from local storage.');
                return;
            }
            
            showSyncIndicator();
            
            fetch(GOOGLE_SHEETS_URL + '?action=load_all&timestamp=' + Date.now())
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    const sheetData = data.data || [];
                    const sheetEditRequests = data.editRequests || [];
                    
                    // Process logbook entries
                    const existingEntriesMap = {};
                    logbookEntries.forEach(entry => {
                        existingEntriesMap[entry.id] = entry;
                    });
                    
                    sheetData.forEach(row => {
                        if (row.id && !existingEntriesMap[row.id]) {
                            // Try to find the user by name if createdBy is not available
                            let createdBy = row.createdBy || '';
                            if (!createdBy && row.pic) {
                                const user = users.find(u => u.name === row.pic);
                                if (user) {
                                    createdBy = user.id;
                                }
                            }
                            
                            const newEntry = {
                                id: row.id,
                                date: row.date || '',
                                pic: row.pic || '',
                                destination: row.destination || '',
                                cashbill: row.cashbill || '',
                                consignment: row.consignment || '',
                                courierType: row.courierType || '',
                                status: row.status || '',
                                committed: row.committed === 'TRUE' || row.committed === true,
                                createdBy: createdBy,
                                createdAt: row.createdAt || '',
                                lastModified: row.lastModified || ''
                            };
                            
                            // Add uncommit tracking if exists
                            if (row.uncommittedBy) {
                                newEntry.uncommittedBy = row.uncommittedBy;
                                newEntry.uncommittedAt = row.uncommittedAt;
                            }
                            
                            logbookEntries.push(newEntry);
                        }
                    });
                    
                    // Process edit requests
                    const existingRequestMap = {};
                    editRequests.forEach(request => {
                        existingRequestMap[request.id] = request;
                    });
                    
                    sheetEditRequests.forEach(request => {
                        if (!existingRequestMap[request.id]) {
                            editRequests.push(request);
                        } else {
                            // Update existing request with server data
                            const existingRequest = existingRequestMap[request.id];
                            if (request.resolved && !existingRequest.resolved) {
                                existingRequest.resolved = request.resolved;
                                existingRequest.resolvedBy = request.resolvedBy;
                                existingRequest.resolvedAt = request.resolvedAt;
                                existingRequest.status = request.status;
                                
                                // Show notification if current user is affected
                                if (request.requestedBy === currentUser.id) {
                                    showSuccessMessage('Your edit request has been ' + (request.status || 'processed'));
                                }
                            }
                        }
                    });
                    
                    // Sort entries by creation date
                    logbookEntries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    saveToLocalStorage();
                    updateUI();
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Data loaded from Google Sheets successfully!');
                } else {
                    console.error('Error syncing with Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error syncing with Google Sheets: ' + data.error);
                    loadFromLocalStorage();
                }
            })
            .catch(error => {
                console.error('Error syncing with Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while syncing with Google Sheets');
                loadFromLocalStorage();
            });
        }
        
        function syncWithGoogleSheets() {
            if (!currentUser) return;
            
            if (!isOnline) {
                showErrorMessage('You are offline. Cannot sync with Google Sheets.');
                return;
            }
            
            loadDataFromGoogleSheets();
        }
        
        function showSyncIndicator() {
            document.getElementById('syncIndicator').classList.add('show');
        }
        
        function hideSyncIndicator() {
            document.getElementById('syncIndicator').classList.remove('show');
        }
        
        function showRealTimeIndicator() {
            const indicator = document.getElementById('realTimeIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }
        
        function hideRealTimeIndicator() {
            document.getElementById('realTimeIndicator').classList.remove('show');
        }
        
        function showSuccessMessage(message) {
            showNotification(message, 'success');
        }
        
        function showErrorMessage(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type = 'info') {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type} ${isDarkMode ? 'dark-mode' : ''}`;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 4000);
        }
        
        // Storage Management
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    users: users,
                    logbookEntries: logbookEntries,
                    deletedEntries: deletedEntries,
                    editRequests: editRequests,
                    activityLogs: activityLogs,
                    entryRemarks: entryRemarks,
                    lastSyncTime: lastSyncTime
                };
                localStorage.setItem('vmCourierData', JSON.stringify(dataToSave));
                debugLog('Data saved to localStorage successfully');
            } catch (error) {
                debugLog('Error saving to localStorage: ' + error.message);
                console.error('Error saving to localStorage:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('vmCourierData');
                if (data) {
                    const parsed = JSON.parse(data);
                    users = parsed.users || users;
                    logbookEntries = parsed.logbookEntries || [];
                    deletedEntries = parsed.deletedEntries || [];
                    editRequests = parsed.editRequests || [];
                    activityLogs = parsed.activityLogs || [];
                    entryRemarks = parsed.entryRemarks || {};
                    lastSyncTime = parsed.lastSyncTime || null;
                    updateUI();
                    debugLog('Data loaded from localStorage successfully');
                }
            } catch (error) {
                debugLog('Error loading from localStorage: ' + error.message);
                console.error('Error loading from localStorage:', error);
            }
        }

        // New Feature: Dark Mode Toggle
        function toggleDarkMode() {
            const body = document.body;
            const isDarkMode = body.classList.contains('dark-mode');
            
            if (isDarkMode) {
                body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-moon me-1"></i>Dark Mode';
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun me-1"></i>Light Mode';
            }
            
            // Update all components with dark mode classes
            updateDarkModeClasses();
        }

        function updateDarkModeClasses() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const elements = document.querySelectorAll('.quick-actions-panel, .search-filter-bar, .stats-dashboard, .stat-card, .stat-number, .stat-label');
            
            elements.forEach(element => {
                if (isDarkMode) {
                    element.classList.add('dark-mode');
                } else {
                    element.classList.remove('dark-mode');
                }
            });
        }

        // New Feature: Quick Actions Panel Toggle
        function toggleQuickActions() {
            const panel = document.getElementById('quickActionsPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                panel.style.animation = 'slideInRight 0.3s ease-out';
            } else {
                panel.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 300);
            }
        }

        // New Feature: Search and Filter Functions
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const courierFilter = document.getElementById('courierFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            let filteredEntries = logbookEntries.filter(entry => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    entry.id.toLowerCase().includes(searchTerm) ||
                    entry.pic.toLowerCase().includes(searchTerm) ||
                    entry.destination.toLowerCase().includes(searchTerm) ||
                    entry.cashbill.toLowerCase().includes(searchTerm) ||
                    entry.consignment.toLowerCase().includes(searchTerm);
                
                // Status filter
                const matchesStatus = !statusFilter || entry.status === statusFilter;
                
                // Courier filter
                const matchesCourier = !courierFilter || entry.courierType === courierFilter;
                
                // Date filter
                let matchesDate = true;
                if (dateFilter) {
                    const entryDate = new Date(entry.date);
                    const today = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            matchesDate = entryDate.toDateString() === today.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesDate = entryDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(today.getFullYear(), today.getMonth(), 1);
                            matchesDate = entryDate >= monthAgo;
                            break;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesCourier && matchesDate;
            });
            
            displayEntries(filteredEntries);
            showSuccessMessage(`Found ${filteredEntries.length} entries matching your filters`);
        }

        // New Feature: Export Data Function
        function exportData() {
            const data = {
                logbookEntries: logbookEntries,
                users: users,
                editRequests: editRequests,
                activityLogs: activityLogs,
                exportDate: new Date().toISOString(),
                exportedBy: currentUser ? currentUser.name : 'Unknown'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `vm-courier-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('Data exported successfully!');
        }

        // New Feature: Keyboard Shortcuts
        document.addEventListener('keydown', function(event) {
            // Only trigger shortcuts when not typing in input fields
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }
            
            switch(event.key.toLowerCase()) {
                case 'q':
                    event.preventDefault();
                    toggleQuickActions();
                    break;
                case 'n':
                    event.preventDefault();
                    if (currentUser) {
                        openAddEntryModal();
                    }
                    break;
                case 's':
                    event.preventDefault();
                    if (event.ctrlKey || event.metaKey) {
                        forceSync();
                    }
                    break;
                case 'd':
                    event.preventDefault();
                    toggleDarkMode();
                    break;
            }
        });

        // Initialize dark mode on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun me-1"></i>Light Mode';
                updateDarkModeClasses();
            }
            
            // Show quick actions panel for logged-in users
            if (currentUser) {
                document.getElementById('quickActionsPanel').style.display = 'block';
            }
        });
    </script>
</body>
</html>

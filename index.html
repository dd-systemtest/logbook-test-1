<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Courier Logbook Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Clean White + Soft Black Theme */
        :root {
            --primary: #1a1a1a;
            --secondary: #666666;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #ffffff;
            --dark: #1a1a1a;
            --soft-gray: #f8f9fa;
            --border-light: #e9ecef;
            --soft-black: #2d2d2d;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --background-primary: #ffffff;
            --background-secondary: #f8f9fa;
            --shadow-light: rgba(0,0,0,0.05);
            --shadow-medium: rgba(0,0,0,0.1);
            --shadow-heavy: rgba(0,0,0,0.15);
        }
        
        body {
            background: var(--background-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--background-secondary) 0%, #e9ecef 100%);
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-card {
            background: var(--background-primary);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow-medium);
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            border: 1px solid var(--border-light);
            animation: slideInUp 0.6s ease-out;
            transition: all 0.3s ease;
        }
        
        .login-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px var(--shadow-heavy);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        .login-header h2 {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            animation: fadeInDown 0.8s ease-out 0.2s both;
        }
        
        .login-header p {
            color: var(--text-secondary);
            margin: 0;
            font-weight: 400;
            animation: fadeInDown 0.8s ease-out 0.4s both;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-control {
            border-radius: 12px;
            padding: 14px 18px;
            border: 2px solid var(--border-light);
            transition: all 0.3s ease;
            background: var(--background-primary);
            font-size: 0.95rem;
            animation: fadeInUp 0.8s ease-out 0.6s both;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(26,26,26,0.15);
            background: var(--background-primary);
            transform: translateY(-2px);
        }
        
        .btn-login {
            background: var(--primary);
            border: none;
            border-radius: 12px;
            padding: 14px 30px;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 1rem;
            animation: fadeInUp 0.8s ease-out 0.8s both;
            position: relative;
            overflow: hidden;
        }
        
        .btn-login:hover {
            background: var(--soft-black);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }
        
        .btn-login:active {
            transform: translateY(0);
        }
        
        .btn-login::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-login:hover::before {
            left: 100%;
        }
        
        .bug-notice {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid var(--danger);
            padding: 1rem;
            margin-top: 2rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
            color: var(--danger);
            animation: fadeInUp 0.8s ease-out 1s both;
        }
        
        .bug-notice i {
            margin-right: 0.5rem;
        }
        
        .main-container {
            background: var(--background-primary);
            min-height: 100vh;
            animation: fadeIn 0.6s ease-out;
        }
        
        .navbar {
            background: var(--background-primary);
            box-shadow: 0 2px 20px var(--shadow-light);
            padding: 1.2rem 0;
            border-bottom: 1px solid var(--border-light);
            animation: slideInDown 0.6s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.6rem;
            transition: all 0.3s ease;
        }
        
        .navbar-brand:hover {
            color: var(--soft-black);
            transform: scale(1.05);
        }
        
        .nav-link {
            font-weight: 500;
            margin: 0 8px;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: var(--text-primary) !important;
            padding: 8px 16px;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary);
            transition: left 0.3s ease;
            z-index: -1;
        }
        
        .nav-link:hover::before, .nav-link.active::before {
            left: 0;
        }
        
        .nav-link:hover, .nav-link.active {
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .card {
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-light);
            margin-bottom: 2rem;
            overflow: hidden;
            background: var(--background-primary);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px var(--shadow-medium);
        }
        
        .card-header {
            background: var(--background-primary);
            color: var(--text-primary);
            font-weight: 600;
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--soft-gray);
            font-size: 1.1rem;
        }
        
        .card-body {
            padding: 2rem;
            background: var(--background-primary);
        }
        
        .btn {
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--soft-black);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .badge {
            border-radius: 8px;
            font-weight: 500;
            padding: 6px 12px;
        }
        
        .table {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-light);
        }
        
        .table thead th {
            background: var(--background-secondary);
            border: none;
            font-weight: 600;
            color: var(--text-primary);
            padding: 1rem;
            font-size: 0.9rem;
        }
        
        .table tbody tr {
            border-bottom: 1px solid var(--background-secondary);
            transition: all 0.3s ease;
        }
        
        .table tbody tr:hover {
            background: rgba(26,26,26,0.02);
            transform: scale(1.01);
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        
        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .entry-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid var(--border-light);
        }
        
        .committed-entry {
            background: rgba(39,174,96,0.03);
            border-left: 4px solid var(--success);
        }
        
        .edit-request-badge {
            background: var(--warning);
            color: white;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .activity-item {
            border-left: 4px solid var(--primary);
            background: var(--background-primary);
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: 0 12px 12px 0;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            animation: fadeInLeft 0.6s ease-out;
        }
        
        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(26,26,26,0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(26,26,26,0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(26,26,26,0);
            }
        }
        
        .modal-header {
            background: var(--primary);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .modal-content {
            border-radius: 16px;
            border: 1px solid var(--border-light);
            animation: modalSlideIn 0.4s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
        }
        
        .modal.show .modal-dialog {
            transform: none;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 10px;
            border: 2px solid var(--border-light);
        }
        
        .remarks-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 12px;
            background: var(--soft-gray);
        }
        
        .remark-item {
            background: white;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        .remark-author {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .remark-time {
            color: var(--secondary);
            font-size: 0.8rem;
        }
        
        .page-section {
            display: none;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .page-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--primary), var(--soft-black));
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }
        
        .stats-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px var(--shadow-heavy);
        }
        
        .stats-card:hover::before {
            left: 100%;
        }
        
        .stats-number {
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }
        
        .container {
            max-width: 1200px;
        }
        
        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.5rem;
            animation: slideInDown 0.5s ease-out;
        }
        
        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }
        
        .form-select {
            border-radius: 12px;
            padding: 14px 18px;
            border: 2px solid var(--border-light);
            background: var(--background-primary);
            transition: all 0.3s ease;
        }
        
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(26,26,26,0.15);
            transform: translateY(-2px);
        }
        
        .form-label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus + .form-label,
        .form-select:focus + .form-label {
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        .footer {
            background: var(--background-secondary);
            border-top: 1px solid var(--border-light);
            padding: 2rem 0;
            margin-top: 4rem;
            text-align: center;
            animation: fadeInUp 0.8s ease-out;
        }
        
        .footer-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 400;
        }
        
        .footer-copyright {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .footer-divider {
            width: 50px;
            height: 2px;
            background: var(--primary);
            margin: 1rem auto;
            border-radius: 1px;
            animation: expandWidth 1s ease-out 0.5s both;
        }
        
        @keyframes expandWidth {
            from {
                width: 0;
            }
            to {
                width: 50px;
            }
        }
        
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 12px var(--shadow-medium);
            display: none;
            z-index: 1000;
        }
        
        .sync-indicator.show {
            display: block;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .real-time-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--info);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px var(--shadow-medium);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .session-timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--warning);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px var(--shadow-medium);
            z-index: 1000;
            animation: slideInLeft 0.5s ease-out;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .entry-id {
            font-family: monospace;
            font-weight: 600;
            color: var(--text-primary);
            background: rgba(26,26,26,0.05);
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .entry-id:hover {
            background: rgba(26,26,26,0.1);
            transform: scale(1.05);
        }
        
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 9999;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .status-badge {
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px var(--shadow-medium);
        }
        
        .status-pending {
            background-color: var(--warning);
            color: white;
        }
        
        .status-in-transit {
            background-color: var(--info);
            color: white;
        }
        
        .status-delivered {
            background-color: var(--success);
            color: white;
        }
        
        .status-return {
            background-color: var(--danger);
            color: white;
        }
        
        .approval-section {
            background: rgba(23, 162, 184, 0.05);
            border: 1px solid var(--info);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .approval-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .approval-header {
            color: var(--info);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .management-dropdown {
            position: relative;
        }
        
        .management-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--background-primary);
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-medium);
            padding: 0.5rem 0;
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            animation: fadeInDown 0.3s ease-out;
        }
        
        .management-dropdown:hover .management-menu {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .management-item {
            display: block;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .management-item:hover {
            background: var(--background-secondary);
            color: var(--primary);
            transform: translateX(5px);
        }
        
        .admin-approvals-card {
            border-left: 4px solid var(--warning);
        }
        
        .request-card {
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .request-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .real-time-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--info);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: none;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
        }
        
        .real-time-indicator.show {
            display: block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .session-timer {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(26, 26, 26, 0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            display: none;
            z-index: 1000;
            animation: slideInLeft 0.5s ease-out;
        }
        
        .session-timer.show {
            display: block;
        }
        
        .admin-contact-btn {
            background: var(--text-secondary);
            color: white;
            cursor: not-allowed;
        }
        
        .admin-contact-btn:hover {
            background: var(--text-secondary);
            transform: none;
            box-shadow: none;
        }
        
        .uncommitted-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--warning);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .permission-info {
            font-size: 0.8rem;
            color: var(--secondary);
            margin-top: 0.25rem;
        }
        
        .system-remark {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .system-remark .remark-author {
            color: #2196f3;
        }
        
        /* Login Logo Styles - Made smaller */
        .login-logo {
            max-height: 50px; /* Reduced from 60px */
            width: auto;
            background: transparent;
            border: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            transition: all 0.3s ease;
            animation: fadeInDown 0.8s ease-out 0.2s both;
        }
        
        .login-logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
        }
        
        /* Enhanced Search Functionality Styles */
        .search-section {
            margin-bottom: 2rem;
        }
        
        .search-card {
            background: var(--background-primary);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-light);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .search-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--shadow-medium);
        }
        
        .search-card-body {
            padding: 1.5rem;
        }
        
        .search-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-input-group {
            position: relative;
            flex: 1;
            min-width: 300px;
        }
        
        .search-input {
            width: 100%;
            border-radius: 25px;
            border: 2px solid var(--border-light);
            padding: 10px 20px 10px 50px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--background-secondary);
        }
        
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(26,26,26,0.15);
            background: var(--background-primary);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .search-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .search-button {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid var(--primary);
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .search-button:hover {
            background: var(--soft-black);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .clear-button {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-light);
            background: var(--background-primary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .clear-button:hover {
            background: var(--background-secondary);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .action-button {
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .view-deleted-btn {
            border: 2px solid var(--border-light);
            background: var(--background-primary);
            color: var(--text-secondary);
        }
        
        .view-deleted-btn:hover {
            background: var(--background-secondary);
            color: var(--text-primary);
        }
        
        .add-entry-btn {
            border: none;
            background: var(--primary);
            color: white;
        }
        
        .add-entry-btn:hover {
            background: var(--soft-black);
        }
        
        .search-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .search-filter-tag {
            background: var(--background-secondary);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        .search-filter-tag:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .search-filter-tag.active {
            background: var(--primary);
            color: white;
        }
        
        .search-results-info {
            background: var(--background-secondary);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
        }
        
        .search-results-count {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .search-query {
            color: var(--primary);
            font-family: monospace;
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .no-results i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        mark {
            background-color: #fff3cd;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .search-highlight {
            animation: highlightPulse 1s ease-in-out;
        }
        
        @keyframes highlightPulse {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
            100% { background-color: #fff3cd; }
        }
        
        .search-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .search-hint i {
            margin-right: 0.3rem;
        }
        
        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
        }
        
        .pagination-info {
            margin-right: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .pagination {
            display: flex;
            gap: 0.5rem;
        }
        
        .page-btn {
            min-width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background: var(--background-primary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .page-btn:hover {
            background: var(--background-secondary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-btn:disabled:hover {
            transform: none;
            background: var(--background-primary);
            border-color: var(--border-light);
        }
        
        .page-size-selector {
            margin-left: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .page-size-selector select {
            border-radius: 8px;
            border: 1px solid var(--border-light);
            padding: 0.5rem;
            background: var(--background-primary);
            color: var(--text-primary);
        }
        
        /* Enhanced Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Focus styles for better keyboard navigation */
        a:focus, button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Skip to content link for screen readers */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 0 0 8px 0;
            z-index: 100;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner-lg {
            width: 3rem;
            height: 3rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Enhanced error states */
        .form-control.is-invalid {
            border-color: var(--danger);
            background-image: none;
        }
        
        .form-control.is-invalid:focus {
            border-color: var(--danger);
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: var(--danger);
        }
        
        /* Success states */
        .form-control.is-valid {
            border-color: var(--success);
            background-image: none;
        }
        
        .form-control.is-valid:focus {
            border-color: var(--success);
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .valid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: var(--success);
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .search-row {
                flex-direction: column;
            }
            
            .search-input-group {
                min-width: 100%;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .table thead th,
            .table tbody td {
                padding: 0.5rem;
            }
            
            .entry-photo {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner-lg"></div>
    </div>
    
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="https://raw.githubusercontent.com/dd-systemtest/courier-logbook/refs/heads/main/IMG_6714.webp" 
                     alt="VM Courier Logbook Logo" 
                     class="login-logo mb-3">
                <h2>VM Courier Logbook</h2>
                <p>Village Mall Portal</p>
            </div>
            <form id="loginForm" novalidate>
                <div class="mb-3">
                    <label for="loginId" class="form-label">User ID</label>
                    <input type="text" class="form-control" id="loginId" required aria-describedby="loginIdHelp">
                    <div id="loginIdHelp" class="form-text">Enter your user ID to continue</div>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required aria-describedby="loginPasswordHelp">
                    <div id="loginPasswordHelp" class="form-text">Enter your password</div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-login" aria-label="Login to the system">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </button>
                </div>
            </form>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;" role="alert"></div>
            
            <!-- Bug report notice -->
            <div class="bug-notice" role="alert">
                <i class="fas fa-bug"></i>
                <strong>Note:</strong> If you found any issues or bug please contact 7434 for fix
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="mainApp" class="main-container" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg" role="navigation" aria-label="Main navigation">
            <div class="container">
                <span class="navbar-brand">
                    <i class="fas fa-clipboard-list me-2" aria-hidden="true"></i>VM Courier Logbook
                </span>
                <div class="navbar-nav ms-auto">
                    <!-- Management Dropdown -->
                    <div class="nav-item management-dropdown me-2">
                        <a class="nav-link" href="#" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-cogs me-1" aria-hidden="true"></i>Management
                        </a>
                        <div class="management-menu" role="menu">
                            <a class="management-item" href="#" onclick="showPage('logbook')" role="menuitem">
                                <i class="fas fa-book me-2" aria-hidden="true"></i>Logbook
                            </a>
                            <a class="management-item" href="#" onclick="showPage('users')" role="menuitem">
                                <i class="fas fa-users me-2" aria-hidden="true"></i>Users
                            </a>
                        </div>
                    </div>
                    
                    <!-- Admin Approvals (only visible to admins) -->
                    <a class="nav-link me-2" id="adminApprovalsLink" href="#" onclick="showPage('adminApprovals')" style="display: none;">
                        <i class="fas fa-clipboard-check me-1" aria-hidden="true"></i>Admin Approvals
                        <span id="adminApprovalBadge" class="notification-badge" style="display: none;">0</span>
                    </a>
                    
                    <!-- Profile Dropdown -->
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <div class="user-avatar d-inline-flex me-2" id="userAvatar" aria-hidden="true"></div>
                            <span id="currentUserName"></span>
                            <span id="editRequestBadge" class="notification-badge" style="display: none;">0</span>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="profileDropdown">
                            <li><a class="dropdown-item" href="#" onclick="toggleDebug()" aria-label="Toggle debug mode">
                                <i class="fas fa-bug me-2" aria-hidden="true"></i>Toggle Debug
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="forceSync()" aria-label="Force sync with Google Sheets">
                                <i class="fas fa-sync me-2" aria-hidden="true"></i>Force Sync Now
                            </a></li>
                            <li><hr class="dropdown-divider" role="separator"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()" aria-label="Logout from the system">
                                <i class="fas fa-sign-out-alt me-2" aria-hidden="true"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Real-time Sync Indicator -->
        <div id="realTimeIndicator" class="real-time-indicator" role="status" aria-live="polite">
            <i class="fas fa-sync-alt me-1" aria-hidden="true"></i>Syncing...
        </div>
        
        <!-- Session Timer -->
        <div id="sessionTimer" class="session-timer" role="timer" aria-live="polite">
            <i class="fas fa-clock me-1" aria-hidden="true"></i>Session expires in: <span id="sessionTimeLeft">5:00</span>
        </div>
        
        <!-- Main Content -->
        <main id="main-content">
            <!-- Logbook Page -->
            <div id="logbookPage" class="page-section active">
                <div class="container mt-4">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="stats-number" id="totalEntries">0</div>
                                        <div>Total Entries</div>
                                    </div>
                                    <i class="fas fa-clipboard-list fa-2x opacity-75" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="stats-number" id="committedEntries">0</div>
                                        <div>Committed</div>
                                    </div>
                                    <i class="fas fa-lock fa-2x opacity-75" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="stats-number" id="myEntries">0</div>
                                        <div>My Entries</div>
                                    </div>
                                    <i class="fas fa-user fa-2x opacity-75" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="stats-number" id="pendingRequests">0</div>
                                        <div>Edit Requests</div>
                                    </div>
                                    <i class="fas fa-exclamation-triangle fa-2x opacity-75" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Search Section -->
                    <div class="search-section">
                        <div class="search-card">
                            <div class="search-card-body">
                                <div class="search-row">
                                    <div class="search-input-group">
                                        <i class="fas fa-search search-icon" aria-hidden="true"></i>
                                        <input type="text" class="form-control search-input" id="searchInput" 
                                               placeholder="Search entries by ID, Date, PIC, Destination, Cashbill, Consignment, Courier Type, or Status..."
                                               aria-label="Search entries">
                                    </div>
                                    <div class="search-actions">
                                        <button class="btn search-button" onclick="performSearch()" title="Search" aria-label="Perform search">
                                            <i class="fas fa-search" aria-hidden="true"></i>
                                        </button>
                                        <button class="btn clear-button" onclick="clearSearch()" title="Clear search" aria-label="Clear search">
                                            <i class="fas fa-times" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                    <div class="action-buttons">
                                        <button id="viewDeletedBtn" class="btn action-button view-deleted-btn" onclick="toggleDeletedEntries()" style="display: none;" title="View deleted entries">
                                            <i class="fas fa-trash" aria-hidden="true"></i>
                                            <span>Deleted</span>
                                        </button>
                                        <button class="btn action-button add-entry-btn" data-bs-toggle="modal" data-bs-target="#entryModal" onclick="openAddEntryModal()" title="Add new entry">
                                            <i class="fas fa-plus" aria-hidden="true"></i>
                                            <span>Add</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="search-hint">
                                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                                    Search is case-insensitive and matches partial text in any field
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Results Info -->
                    <div id="searchResultsInfo" class="search-results-info" style="display: none;">
                        <div class="search-results-count">
                            Showing <span id="resultsCount">0</span> of <span id="totalCount">0</span> entries
                        </div>
                        <div>
                            Search for: <span class="search-query" id="searchQueryDisplay"></span>
                        </div>
                    </div>
                    
                    <!-- Logbook Entries -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2" aria-hidden="true"></i>Logbook Entries
                                <span id="entriesTitle">All Entries</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" aria-label="Logbook entries table">
                                    <thead>
                                        <tr>
                                            <th scope="col">ID</th>
                                            <th scope="col">Date</th>
                                            <th scope="col">PIC</th>
                                            <th scope="col">Destination</th>
                                            <th scope="col">Cashbill*</th>
                                            <th scope="col">Consignment*</th>
                                            <th scope="col">Courier Type</th>
                                            <th scope="col">Status</th>
                                            <th scope="col">Photo</th>
                                            <th scope="col">Remarks</th>
                                            <th scope="col">Entry Status</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="entriesTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <div class="pagination-container">
                                <div class="pagination-info">
                                    Showing <span id="pageStart">0</span> to <span id="pageEnd">0</span> of <span id="totalEntriesCount">0</span> entries
                                </div>
                                <div class="pagination" role="navigation" aria-label="Pagination navigation">
                                    <button class="page-btn" id="prevPageBtn" onclick="changePage(-1)" aria-label="Previous page">
                                        <i class="fas fa-chevron-left" aria-hidden="true"></i>
                                    </button>
                                    <div id="pageNumbers"></div>
                                    <button class="page-btn" id="nextPageBtn" onclick="changePage(1)" aria-label="Next page">
                                        <i class="fas fa-chevron-right" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="page-size-selector">
                                    <label for="pageSizeSelect" class="form-label">Show:</label>
                                    <select id="pageSizeSelect" class="form-select" onchange="changePageSize()">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Management Page -->
            <div id="usersPage" class="page-section">
                <div class="container mt-4">
                    <div class="row">
                        <!-- User Profile/List -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-users me-2" aria-hidden="true"></i><span id="usersTitle">User Management</span>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="usersList"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Activity Log (Admin Only) -->
                        <div class="col-md-4" id="activityLogSection" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-history me-2" aria-hidden="true"></i>Recent Activity
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="activityLog" style="max-height: 400px; overflow-y: auto;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Approvals Page -->
            <div id="adminApprovalsPage" class="page-section">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="card admin-approvals-card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-clipboard-check me-2" aria-hidden="true"></i>Admin Approvals
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Edit Requests Section -->
                                    <div class="approval-section">
                                        <h6 class="approval-header">
                                            <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>Pending Edit Requests
                                            <span class="badge bg-warning ms-2" id="editRequestsCount">0</span>
                                        </h6>
                                        <div id="editRequestsList">
                                            <p class="text-muted">No pending edit requests.</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Uncommitted Entries Section -->
                                    <div class="approval-section">
                                        <h6 class="approval-header">
                                            <i class="fas fa-clock me-2" aria-hidden="true"></i>Entries Awaiting Re-commit Approval
                                            <span class="badge bg-info ms-2" id="uncommittedCount">0</span>
                                        </h6>
                                        <div id="uncommittedEntriesList">
                                            <p class="text-muted">No entries awaiting re-commit approval.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Entry Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryModalTitle">Add New Entry</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="entryForm" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="entryDate" required aria-describedby="entryDateHelp">
                                    <div id="entryDateHelp" class="form-text">Select the date of the entry</div>
                                    <div class="invalid-feedback">Please select a valid date</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryPIC" class="form-label">PIC (Person in Charge)</label>
                                    <input type="text" class="form-control" id="entryPIC" readonly aria-describedby="entryPICHelp">
                                    <div id="entryPICHelp" class="form-text">Automatically set to current user</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="entryDestination" class="form-label">Destination Trade In Partner</label>
                            <select class="form-select" id="entryDestination" required aria-describedby="entryDestinationHelp">
                                <option value="">Select Destination</option>
                                <option value="ENB">ENB</option>
                                <option value="Remobie">Remobie</option>
                                <option value="Miifix">Miifix</option>
                            </select>
                            <div id="entryDestinationHelp" class="form-text">Select the destination partner</div>
                            <div class="invalid-feedback">Please select a destination</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryCashbill" class="form-label">Cashbill Number *</label>
                                    <input type="text" class="form-control" id="entryCashbill" required placeholder="Enter cashbill number" aria-describedby="entryCashbillHelp">
                                    <div id="entryCashbillHelp" class="form-text">Enter the cashbill number</div>
                                    <div class="invalid-feedback">Please enter a cashbill number</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryConsignment" class="form-label">Consignment Number *</label>
                                    <input type="text" class="form-control" id="entryConsignment" required placeholder="Enter consignment number" aria-describedby="entryConsignmentHelp">
                                    <div id="entryConsignmentHelp" class="form-text">Enter the consignment number</div>
                                    <div class="invalid-feedback">Please enter a consignment number</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryCourierType" class="form-label">Courier Type</label>
                                    <select class="form-select" id="entryCourierType" required aria-describedby="entryCourierTypeHelp">
                                        <option value="">Select Courier</option>
                                        <option value="eDHL">eDHL</option>
                                        <option value="Poslaju">Poslaju</option>
                                        <option value="GDex">GDex</option>
                                        <option value="Others">Others</option>
                                    </select>
                                    <div id="entryCourierTypeHelp" class="form-text">Select the courier type</div>
                                    <div class="invalid-feedback">Please select a courier type</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryStatus" class="form-label">Status</label>
                                    <select class="form-select" id="entryStatus" required aria-describedby="entryStatusHelp">
                                        <option value="">Select Status</option>
                                        <option value="Pending">Pending</option>
                                        <option value="In transit">In transit</option>
                                        <option value="Delivered">Delivered</option>
                                        <option value="Return">Return</option>
                                    </select>
                                    <div id="entryStatusHelp" class="form-text">Select the current status</div>
                                    <div class="invalid-feedback">Please select a status</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="entryPhoto" class="form-label">Courier Photo Proof</label>
                            <input type="file" class="form-control" id="entryPhoto" accept="image/*" aria-describedby="entryPhotoHelp">
                            <div id="entryPhotoHelp" class="form-text">Upload a photo proof of the courier (optional)</div>
                            <div id="photoPreview"></div>
                        </div>
                        <div class="mb-3">
                            <label for="entryRemarks" class="form-label">Initial Remarks (Optional)</label>
                            <textarea class="form-control" id="entryRemarks" rows="3" aria-describedby="entryRemarksHelp"></textarea>
                            <div id="entryRemarksHelp" class="form-text">Add any initial remarks about this entry</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEntry()">
                        <span id="saveButtonText">Save Entry</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Remarks Modal -->
    <div class="modal fade" id="remarksModal" tabindex="-1" aria-labelledby="remarksModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="remarksModalTitle">Entry Remarks</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="remarks-list" id="remarksList" aria-live="polite"></div>
                    <div class="mt-3">
                        <label for="newRemark" class="form-label">Add New Remark</label>
                        <textarea class="form-control" id="newRemark" rows="3" placeholder="Enter your remark..." aria-describedby="newRemarkHelp"></textarea>
                        <div id="newRemarkHelp" class="form-text">Enter your remark about this entry</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addRemark()">Add Remark</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Request Modal -->
    <div class="modal fade" id="editRequestModal" tabindex="-1" aria-labelledby="editRequestModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRequestModalTitle">Request Edit Permission</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This entry is committed and locked. Please provide a reason for requesting edit permission:</p>
                    <textarea class="form-control" id="editRequestReason" rows="4" placeholder="Reason for edit request..." required aria-describedby="editRequestReasonHelp"></textarea>
                    <div id="editRequestReasonHelp" class="form-text">Provide a detailed reason for your edit request</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitEditRequest()">Submit Request</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Photo View Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="photoModalTitle">Courier Photo Proof</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPhoto" class="img-fluid" style="max-height: 70vh;" alt="Courier photo proof">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Contact Modal -->
    <div class="modal fade" id="adminContactModal" tabindex="-1" aria-labelledby="adminContactModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminContactModalTitle">Admin Contact Required</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        <strong>This entry is committed and locked.</strong><br>
                        To edit this entry, please contact the administrator:<br><br>
                        <strong>Danial Danish</strong><br>
                        ID: 7434<br>
                        <i class="fas fa-phone me-2" aria-hidden="true"></i> Contact for uncommit permission
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-copyright">VM Courier Logbook</div>
                <div class="footer-divider"></div>
                <div>Copyright © 2025 by ddsystem. All rights reserved.</div>
            </div>
        </div>
    </footer>
    
    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator" role="status" aria-live="polite">
        <div class="loading-spinner me-2" aria-hidden="true"></div>Syncing with Google Sheets...
    </div>
    
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel" role="log" aria-live="polite">
        <div><strong>Debug Panel</strong></div>
        <div id="debugContent"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Malaysia Time Helper Functions
        function getMalaysiaTime() {
            const now = new Date();
            const malaysiaTime = new Date(now.getTime() + (8 * 60 * 60 * 1000) + (now.getTimezoneOffset() * 60 * 1000));
            return malaysiaTime;
        }
        
        function formatMalaysiaDateTime(date) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'Asia/Kuala_Lumpur'
            };
            return new Date(date).toLocaleString('en-MY', options);
        }
        
        function formatMalaysiaDate(date) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'Asia/Kuala_Lumpur'
            };
            return new Date(date).toLocaleDateString('en-MY', options);
        }
        
        // Application State
        let currentUser = null;
        let currentEntryId = null;
        let currentRemarksEntryId = null;
        let showingDeleted = false;
        let isOnline = navigator.onLine;
        let debugMode = false;
        let syncInterval = null;
        let sessionTimeout = null;
        let sessionTimeLeft = 300; // 5 minutes in seconds
        
        // Pagination state
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 0;
        
        // Search state
        let searchQuery = '';
        let filteredEntries = [];
        
        // Google Sheets Integration
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbwe84Ec0M5f_0S2QwPWwIrNeGYblfk0AfacEGLTQdRsoRRuP1kXnqrpGXGUrLzyvuyX/exec";
        
        // Data Storage
        let users = [
            { id: '7434', name: 'Danial Danish', role: 'admin', password: 'Danial05', canCommit: true },
            { id: '4545', name: 'Ain Ismail', role: 'TL', password: 'Ain123', canCommit: true },
            { id: '5546', name: 'Cindamani Anam', role: 'RSE', password: 'Ann123', canCommit: true },
            { id: '7701', name: 'Syarifuddin Mat Razali', role: 'RSA', password: 'Din123', canCommit: true },
            { id: '7407', name: 'Nur Sabrina', role: 'RSA', password: 'Sab123', canCommit: true },
            { id: '7940', name: 'Eisya Nasir', role: 'RSA', password: 'Eisya123', canCommit: true },
            { id: '6435', name: 'Lee Shean Yi', role: 'RSA', password: 'Lee123', canCommit: true },
            { id: '0690', name: 'Kavindhran', role: 'AH', password: 'Kavin123', canCommit: true }
        ];
        
        let logbookEntries = [];
        let deletedEntries = [];
        let editRequests = [];
        let activityLogs = [];
        let entryRemarks = {};
        let lastSyncTime = null;
        
        // Debug function
        function debugLog(message) {
            if (debugMode) {
                console.log(message);
                const debugContent = document.getElementById('debugContent');
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('show', debugMode);
            if (debugMode) {
                debugLog('Debug mode enabled');
                debugLog('Current user: ' + (currentUser ? currentUser.name : 'None'));
                debugLog('Logbook entries: ' + logbookEntries.length);
                debugLog('Edit requests: ' + editRequests.length);
            }
        }
        
        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkLoginStatus();
            
            // Monitor online/offline status
            window.addEventListener('online', () => {
                isOnline = true;
                showSuccessMessage('You are back online!');
                syncWithGoogleSheets();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
            });
            
            // Set up real-time sync interval
            setupRealTimeSync();
            
            // Set up session timeout
            setupSessionTimeout();
            
            // Initialize pagination
            updatePagination();
        });
        
        // Session timeout management
        function setupSessionTimeout() {
            // Update session timer display
            updateSessionTimerDisplay();
            
            // Set up interval to update session timer every second
            setInterval(() => {
                if (currentUser) {
                    sessionTimeLeft--;
                    updateSessionTimerDisplay();
                    
                    if (sessionTimeLeft <= 0) {
                        logout();
                    }
                }
            }, 1000);
            
            // Reset session timeout on user activity
            document.addEventListener('mousemove', resetSessionTimeout);
            document.addEventListener('keypress', resetSessionTimeout);
            document.addEventListener('click', resetSessionTimeout);
            document.addEventListener('scroll', resetSessionTimeout);
        }
        
        function updateSessionTimerDisplay() {
            const minutes = Math.floor(sessionTimeLeft / 60);
            const seconds = sessionTimeLeft % 60;
            const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            const sessionTimer = document.getElementById('sessionTimer');
            const sessionTimeLeftElement = document.getElementById('sessionTimeLeft');
            
            if (currentUser) {
                sessionTimer.classList.add('show');
                sessionTimeLeftElement.textContent = timeString;
            } else {
                sessionTimer.classList.remove('show');
            }
        }
        
        function resetSessionTimeout() {
            if (currentUser) {
                sessionTimeLeft = 300; // Reset to 5 minutes
                debugLog('Session timeout reset');
            }
        }
        
        // Setup real-time synchronization
        function setupRealTimeSync() {
            // Clear any existing interval
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // Sync every 30 seconds when online
            syncInterval = setInterval(() => {
                if (isOnline && currentUser) {
                    performRealTimeSync();
                }
            }, 30000);
            
            // Also sync when page becomes visible again
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && isOnline && currentUser) {
                    performRealTimeSync();
                }
            });
        }
        
        // Perform real-time sync for edit requests and critical data
        function performRealTimeSync() {
            if (!currentUser || !isOnline) return;
            
            debugLog('Performing real-time sync...');
            showRealTimeIndicator();
            
            fetch(GOOGLE_SHEETS_URL + '?action=sync_requests&timestamp=' + Date.now())
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    const serverRequests = data.editRequests || [];
                    const serverEntries = data.entries || [];
                    
                    // Check for new edit requests
                    const localRequestIds = editRequests.map(r => r.id);
                    const newRequests = serverRequests.filter(r => !localRequestIds.includes(r.id));
                    
                    if (newRequests.length > 0) {
                        debugLog('Found ' + newRequests.length + ' new edit requests');
                        // Add new requests to local storage
                        newRequests.forEach(request => {
                            editRequests.unshift(request);
                        });
                        updateUI();
                        
                        // Show notification for admin users
                        if (currentUser.role === 'admin') {
                            showSuccessMessage('New edit request received!');
                        }
                    }
                    
                    // Check for resolved requests
                    const resolvedRequests = editRequests.filter(localReq => {
                        const serverReq = serverRequests.find(r => r.id === localReq.id);
                        return serverReq && serverReq.resolved && !localReq.resolved;
                    });
                    
                    if (resolvedRequests.length > 0) {
                        debugLog('Found ' + resolvedRequests.length + ' resolved requests');
                        // Update local requests
                        resolvedRequests.forEach(localReq => {
                            const serverReq = serverRequests.find(r => r.id === localReq.id);
                            if (serverReq) {
                                localReq.resolved = serverReq.resolved;
                                localReq.resolvedBy = serverReq.resolvedBy;
                                localReq.resolvedAt = serverReq.resolvedAt;
                                localReq.status = serverReq.status;
                            }
                        });
                        updateUI();
                        
                        // Show notification for requesters
                        resolvedRequests.forEach(req => {
                            if (req.requestedBy === currentUser.id) {
                                showSuccessMessage('Your edit request has been ' + (req.status || 'processed'));
                            }
                        });
                    }
                    
                    // Check for updated entries (especially uncommitted ones)
                    const updatedEntries = serverEntries.filter(serverEntry => {
                        const localEntry = logbookEntries.find(e => e.id === serverEntry.id);
                        return localEntry && localEntry.committed !== serverEntry.committed;
                    });
                    
                    if (updatedEntries.length > 0) {
                        debugLog('Found ' + updatedEntries.length + ' updated entries');
                        updatedEntries.forEach(serverEntry => {
                            const localEntry = logbookEntries.find(e => e.id === serverEntry.id);
                            if (localEntry) {
                                localEntry.committed = serverEntry.committed;
                                if (serverEntry.committed) {
                                    localEntry.committedBy = serverEntry.committedBy;
                                    localEntry.committedAt = serverEntry.committedAt;
                                } else {
                                    delete localEntry.committedBy;
                                    delete localEntry.committedAt;
                                }
                            }
                        });
                        updateUI();
                    }
                    
                    hideRealTimeIndicator();
                    saveToLocalStorage();
                } else {
                    debugLog('Real-time sync failed: ' + data.error);
                    hideRealTimeIndicator();
                }
            })
            .catch(error => {
                debugLog('Real-time sync error: ' + error.message);
                hideRealTimeIndicator();
            });
        }
        
        // Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('entryPhoto').addEventListener('change', handlePhotoPreview);
            
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch();
                    }, 300); // Debounce search to avoid excessive filtering
                });
                
                // Add Enter key support
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
            
            // Form validation
            const forms = document.querySelectorAll('.needs-validation');
            forms.forEach(form => {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }
        
        // Login Management
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('vmCourierUser');
            
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const user = users.find(u => u.id === userData.id);
                if (user) {
                    loginUser(user);
                    return;
                }
            }
            
            showLoginPage();
        }
        
        function handleLogin(e) {
            e.preventDefault();
            
            // Get form elements
            const loginForm = document.getElementById('loginForm');
            const idInput = document.getElementById('loginId');
            const passwordInput = document.getElementById('loginPassword');
            
            // Reset validation states
            loginForm.classList.remove('was-validated');
            idInput.classList.remove('is-invalid', 'is-valid');
            passwordInput.classList.remove('is-invalid', 'is-valid');
            
            const id = idInput.value.trim();
            const password = passwordInput.value;
            
            let isValid = true;
            
            // Validate ID
            if (!id) {
                idInput.classList.add('is-invalid');
                isValid = false;
            } else {
                idInput.classList.add('is-valid');
            }
            
            // Validate password
            if (!password) {
                passwordInput.classList.add('is-invalid');
                isValid = false;
            } else {
                passwordInput.classList.add('is-valid');
            }
            
            if (!isValid) {
                return;
            }
            
            debugLog('Login attempt with ID: ' + id);
            
            const user = users.find(u => u.id === id && u.password === password);
            
            if (user) {
                // Always save user to localStorage
                localStorage.setItem('vmCourierUser', JSON.stringify({id: user.id}));
                loginUser(user);
            } else {
                showLoginError('Invalid ID or password');
                passwordInput.classList.add('is-invalid');
            }
        }
        
        function loginUser(user) {
            currentUser = user;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Reset session timeout
            resetSessionTimeout();
            
            // Update UI
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0);
            
            // Show admin features
            if (user.role === 'admin') {
                document.getElementById('viewDeletedBtn').style.display = 'inline-flex';
                document.getElementById('activityLogSection').style.display = 'block';
                document.getElementById('adminApprovalsLink').style.display = 'block';
            }
            
            // Set up real-time sync
            setupRealTimeSync();
            
            // Load data from Google Sheets
            loadDataFromGoogleSheets();
            
            logActivity('Login', `${user.name} logged in`);
            debugLog('User logged in: ' + user.name);
        }
        
        function logout() {
            if (currentUser) {
                logActivity('Logout', `${currentUser.name} logged out`);
                debugLog('User logged out: ' + currentUser.name);
            }
            
            // Clear sync interval
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            currentUser = null;
            localStorage.removeItem('vmCourierUser');
            showLoginPage();
        }
        
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
            
            // Reset validation states
            const loginForm = document.getElementById('loginForm');
            loginForm.classList.remove('was-validated');
            document.getElementById('loginId').classList.remove('is-invalid', 'is-valid');
            document.getElementById('loginPassword').classList.remove('is-invalid', 'is-valid');
        }
        
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Page Navigation with Animation
        function showPage(page) {
            // Hide all pages with animation
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page with animation
            setTimeout(() => {
                document.getElementById(page + 'Page').classList.add('active');
            }, 100);
            
            // Set active nav link
            if (page === 'adminApprovals') {
                document.getElementById('adminApprovalsLink').classList.add('active');
            }
            
            // Load page content
            if (page === 'logbook') {
                loadLogbookPage();
            } else if (page === 'users') {
                loadUsersPage();
            } else if (page === 'adminApprovals') {
                loadAdminApprovalsPage();
            }
            
            // Perform real-time sync when switching pages
            if (isOnline && currentUser) {
                setTimeout(() => performRealTimeSync(), 500);
            }
        }
        
        // Pagination Functions
        function updatePagination() {
            const entries = showingDeleted ? deletedEntries : logbookEntries;
            const filtered = searchQuery ? filteredEntries : entries;
            
            // Calculate total pages
            totalPages = Math.ceil(filtered.length / pageSize);
            
            // Ensure current page is within bounds
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            // Calculate start and end indices
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filtered.length);
            
            // Update pagination info
            document.getElementById('pageStart').textContent = filtered.length > 0 ? startIndex + 1 : 0;
            document.getElementById('pageEnd').textContent = endIndex;
            document.getElementById('totalEntriesCount').textContent = filtered.length;
            
            // Update page buttons
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            
            // Update page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            // Show page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'page-btn';
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pageNumbers.appendChild(pageBtn);
            }
        }
        
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderFilteredEntries();
                updatePagination();
            }
        }
        
        function goToPage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderFilteredEntries();
                updatePagination();
            }
        }
        
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1; // Reset to first page
            renderFilteredEntries();
            updatePagination();
        }
        
        // Search Functions
        function performSearch() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            currentPage = 1; // Reset to first page when searching
            filterAndRenderEntries();
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchQuery = '';
            currentPage = 1; // Reset to first page
            filterAndRenderEntries();
        }
        
        function filterEntries() {
            if (!searchQuery) {
                return showingDeleted ? deletedEntries : logbookEntries;
            }
            
            const entries = showingDeleted ? deletedEntries : logbookEntries;
            
            return entries.filter(entry => {
                // Search in ID
                if (entry.id && entry.id.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                // Search in Date (formatted)
                const formattedDate = formatMalaysiaDate(entry.date);
                if (formattedDate.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                // Search in PIC
                if (entry.pic && entry.pic.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                // Search in Destination
                if (entry.destination && entry.destination.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                // Search in Cashbill
                if (entry.cashbill && entry.cashbill.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                // Search in Consignment
                if (entry.consignment && entry.consignment.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                // Search in Courier Type
                if (entry.courierType && entry.courierType.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                // Search in Status
                if (entry.status && entry.status.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                return false;
            });
        }
        
        function filterAndRenderEntries() {
            filteredEntries = filterEntries();
            renderFilteredEntries();
            updatePagination();
        }
        
        function renderFilteredEntries() {
            const tbody = document.getElementById('entriesTableBody');
            tbody.innerHTML = '';
            
            let entriesToRender = searchQuery ? filteredEntries : (showingDeleted ? deletedEntries : logbookEntries);
            const totalCount = showingDeleted ? deletedEntries.length : logbookEntries.length;
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, entriesToRender.length);
            const paginatedEntries = entriesToRender.slice(startIndex, endIndex);
            
            // Update search results info
            const searchResultsInfo = document.getElementById('searchResultsInfo');
            if (searchQuery) {
                searchResultsInfo.style.display = 'flex';
                document.getElementById('resultsCount').textContent = entriesToRender.length;
                document.getElementById('totalCount').textContent = totalCount;
                document.getElementById('searchQueryDisplay').textContent = searchQuery;
            } else {
                searchResultsInfo.style.display = 'none';
            }
            
            // Update the title
            const titleElement = document.getElementById('entriesTitle');
            if (searchQuery) {
                titleElement.innerHTML = `Search Results (${entriesToRender.length} of ${totalCount} entries)`;
            } else {
                titleElement.textContent = showingDeleted ? 'Deleted Entries' : 'All Entries';
            }
            
            if (paginatedEntries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center py-4">
                            <div class="no-results">
                                <i class="fas fa-search" aria-hidden="true"></i>
                                <p class="mb-0">No entries found</p>
                                ${searchQuery ? '<small class="text-muted">Try adjusting your search criteria</small>' : ''}
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            paginatedEntries.forEach(entry => {
                const row = document.createElement('tr');
                if (entry.committed) {
                    row.classList.add('committed-entry');
                }
                
                const hasEditRequest = editRequests.some(r => r.entryId === entry.id && !r.resolved);
                const editRequestBadge = hasEditRequest ? 
                    '<span class="edit-request-badge ms-2">Edit Requested</span>' : '';
                
                let statusBadge = '';
                if (entry.status) {
                    let statusClass = '';
                    switch(entry.status) {
                        case 'Pending':
                            statusClass = 'status-pending';
                            break;
                        case 'In transit':
                            statusClass = 'status-in-transit';
                            break;
                        case 'Delivered':
                            statusClass = 'status-delivered';
                            break;
                        case 'Return':
                            statusClass = 'status-return';
                            break;
                    }
                    statusBadge = `<span class="status-badge ${statusClass}">${entry.status}</span>`;
                }
                
                // Highlight search matches
                function highlightMatch(text) {
                    if (!searchQuery || !text) return text || '';
                    const regex = new RegExp(`(${searchQuery})`, 'gi');
                    return text.toString().replace(regex, '<mark>$1</mark>');
                }
                
                const formattedDate = formatMalaysiaDate(entry.date);
                
                row.innerHTML = `
                    <td><span class="entry-id">${highlightMatch(entry.id)}</span></td>
                    <td>${highlightMatch(formattedDate)}</td>
                    <td>${highlightMatch(entry.pic)}${editRequestBadge}</td>
                    <td><span class="badge bg-primary">${highlightMatch(entry.destination)}</span></td>
                    <td><span class="text-muted">${highlightMatch(entry.cashbill || 'N/A')}</span></td>
                    <td><span class="text-muted">${highlightMatch(entry.consignment || 'N/A')}</span></td>
                    <td>${highlightMatch(entry.courierType || 'N/A')}</td>
                    <td>${statusBadge || '<span class="text-muted">Not set</span>'}</td>
                    <td>
                        ${entry.photo ? 
                            `<img src="${entry.photo}" class="entry-photo" onclick="viewPhoto('${entry.photo}')" alt="Courier photo proof">` : 
                            '<span class="text-muted">No photo</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewRemarks('${entry.id}')" aria-label="View remarks for entry ${entry.id}">
                            <i class="fas fa-comment" aria-hidden="true"></i> 
                            ${entryRemarks[entry.id] ? entryRemarks[entry.id].length : 0}
                        </button>
                    </td>
                    <td>
                        ${entry.committed ? 
                            '<span class="badge bg-success"><i class="fas fa-lock" aria-hidden="true"></i> Committed</span>' : 
                            '<span class="badge bg-warning text-dark"><i class="fas fa-unlock" aria-hidden="true"></i> Draft</span>'
                        }
                    </td>
                    <td>${renderActionButtons(entry)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Logbook Management
        function loadLogbookPage() {
            updateStats();
            filterAndRenderEntries();
            updatePagination();
            updateEditRequestBadge();
        }
        
        function updateStats() {
            const total = logbookEntries.length;
            const committed = logbookEntries.filter(e => e.committed).length;
            const myEntries = logbookEntries.filter(e => e.createdBy === currentUser.id).length;
            const requests = editRequests.filter(r => !r.resolved).length;
            
            document.getElementById('totalEntries').textContent = total;
            document.getElementById('committedEntries').textContent = committed;
            document.getElementById('myEntries').textContent = myEntries;
            document.getElementById('pendingRequests').textContent = requests;
        }
        
        function renderActionButtons(entry) {
            debugLog('Rendering action buttons for entry:', entry);
            debugLog('Current user:', currentUser);
            debugLog('Entry committed:', entry.committed);
            debugLog('Entry PIC:', entry.pic);
            debugLog('Current user name:', currentUser.name);
            
            if (showingDeleted) {
                return currentUser.role === 'admin' ? `
                    <button class="btn btn-sm btn-success me-1" onclick="restoreEntry('${entry.id}')" aria-label="Restore entry ${entry.id}">
                        <i class="fas fa-undo" aria-hidden="true"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="permanentlyDeleteEntry('${entry.id}')" aria-label="Permanently delete entry ${entry.id}">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                    </button>
                ` : '';
            }
            
            let buttons = '';
            const isCreator = entry.createdBy === currentUser.id;
            const isPIC = entry.pic === currentUser.name;
            
            // Edit button logic
            if (entry.committed) {
                // Committed entries - only admin can edit
                if (currentUser.role === 'admin') {
                    debugLog('Showing edit button for admin on committed entry');
                    buttons += `<button class="btn btn-sm btn-primary me-1" onclick="editEntry('${entry.id}')" aria-label="Edit entry ${entry.id}">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                    </button>`;
                } else {
                    debugLog('Showing admin contact button for non-admin on committed entry');
                    buttons += `<button class="btn btn-sm admin-contact-btn me-1" onclick="showAdminContact()" aria-label="Contact admin to edit entry ${entry.id}">
                        <i class="fas fa-edit" aria-hidden="true"></i> Edit
                    </button>`;
                }
            } else {
                // Uncommitted entries - creator, PIC, or admin can edit
                if (currentUser.role === 'admin' || isCreator || isPIC) {
                    debugLog('Showing edit button for uncommitted entry - user has permission');
                    buttons += `<button class="btn btn-sm btn-primary me-1" onclick="editEntry('${entry.id}')" aria-label="Edit entry ${entry.id}">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                    </button>`;
                } else {
                    debugLog('Not showing edit button for uncommitted entry - user does not have permission');
                }
            }
            
            // Delete button
            if (currentUser.role === 'admin' || 
                (isCreator && !entry.committed)) {
                buttons += `<button class="btn btn-sm btn-danger me-1" onclick="deleteEntry('${entry.id}')" aria-label="Delete entry ${entry.id}">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                </button>`;
            }
            
            // Commit/Uncommit button - UPDATED LOGIC
            if (!entry.committed) {
                // Allow commit if:
                // 1. User is the creator of the entry, OR
                // 2. User is admin, OR
                // 3. User has canCommit permission AND is NOT the creator
                if (isCreator || currentUser.role === 'admin' || 
                    (currentUser.canCommit && !isCreator)) {
                    buttons += `<button class="btn btn-sm btn-success" onclick="commitEntry('${entry.id}')" aria-label="Commit entry ${entry.id}">
                        <i class="fas fa-lock" aria-hidden="true"></i> Commit
                    </button>`;
                }
            } else if (currentUser.role === 'admin') {
                // Only admin can uncommit
                buttons += `<button class="btn btn-sm btn-secondary" onclick="uncommitEntry('${entry.id}')" aria-label="Uncommit entry ${entry.id}">
                    <i class="fas fa-unlock" aria-hidden="true"></i>
                </button>`;
            }
            
            debugLog('Buttons HTML:', buttons);
            return buttons;
        }
        
        // Generate LBVM sequential ID starting from LBVM001
        function generateNextId() {
            try {
                debugLog('Generating next ID...');
                
                const allEntries = [...logbookEntries, ...deletedEntries];
                debugLog('Total entries found: ' + allEntries.length);
                
                const lbvmEntries = allEntries.filter(entry => entry.id && entry.id.startsWith('LBVM'));
                debugLog('LBVM entries found: ' + lbvmEntries.length);
                
                if (lbvmEntries.length === 0) {
                    debugLog('No LBVM entries found, starting with LBVM001');
                    return "LBVM001";
                }
                
                let maxNum = 0;
                lbvmEntries.forEach(entry => {
                    const numStr = entry.id.substring(4);
                    const num = parseInt(numStr, 10);
                    if (!isNaN(num) && num > maxNum) {
                        maxNum = num;
                    }
                });
                
                debugLog('Max number found: ' + maxNum);
                
                const nextNum = maxNum + 1;
                const nextNumStr = String(nextNum).padStart(3, '0');
                const newId = `LBVM${nextNumStr}`;
                
                debugLog('Generated new ID: ' + newId);
                return newId;
            } catch (error) {
                debugLog('Error generating ID: ' + error.message);
                return "LBVM" + Date.now();
            }
        }
        
        // Entry Management
        function openAddEntryModal() {
            currentEntryId = null;
            document.getElementById('entryModalTitle').textContent = 'Add New Entry';
            
            // Reset form and validation states
            const entryForm = document.getElementById('entryForm');
            entryForm.reset();
            entryForm.classList.remove('was-validated');
            
            // Remove validation classes
            entryForm.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            const malaysiaDate = getMalaysiaTime();
            document.getElementById('entryDate').value = malaysiaDate.toISOString().split('T')[0];
            
            document.getElementById('entryPIC').value = currentUser.name;
            document.getElementById('entryCashbill').value = '';
            document.getElementById('entryConsignment').value = '';
            document.getElementById('entryCourierType').value = '';
            document.getElementById('entryStatus').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('saveButtonText').textContent = 'Save Entry';
            debugLog('Opened add entry modal');
        }
        
        function saveEntry() {
            debugLog('Save entry called');
            
            // Get form elements
            const entryForm = document.getElementById('entryForm');
            const dateInput = document.getElementById('entryDate');
            const destinationSelect = document.getElementById('entryDestination');
            const cashbillInput = document.getElementById('entryCashbill');
            const consignmentInput = document.getElementById('entryConsignment');
            const courierTypeSelect = document.getElementById('entryCourierType');
            const statusSelect = document.getElementById('entryStatus');
            
            // Reset validation states
            entryForm.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            const date = dateInput.value;
            const destination = destinationSelect.value;
            const cashbill = cashbillInput.value.trim();
            const consignment = consignmentInput.value.trim();
            const courierType = courierTypeSelect.value;
            const status = statusSelect.value;
            const photoFile = document.getElementById('entryPhoto').files[0];
            const remarks = document.getElementById('entryRemarks').value.trim();
            
            debugLog('Form data:', { date, destination, cashbill, consignment, courierType, status, remarks, hasPhoto: !!photoFile });
            
            let isValid = true;
            
            // Validate required fields
            if (!date) {
                dateInput.classList.add('is-invalid');
                isValid = false;
            } else {
                dateInput.classList.add('is-valid');
            }
            
            if (!destination) {
                destinationSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                destinationSelect.classList.add('is-valid');
            }
            
            if (!cashbill) {
                cashbillInput.classList.add('is-invalid');
                isValid = false;
            } else {
                cashbillInput.classList.add('is-valid');
            }
            
            if (!consignment) {
                consignmentInput.classList.add('is-invalid');
                isValid = false;
            } else {
                consignmentInput.classList.add('is-valid');
            }
            
            if (!courierType) {
                courierTypeSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                courierTypeSelect.classList.add('is-valid');
            }
            
            if (!status) {
                statusSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                statusSelect.classList.add('is-valid');
            }
            
            if (!isValid) {
                showErrorMessage('Please fill in all required fields');
                return;
            }
            
            let photoData = null;
            if (photoFile) {
                debugLog('Processing photo file...');
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                    debugLog('Photo loaded, size: ' + photoData.length);
                    saveEntryWithPhoto(date, destination, cashbill, consignment, courierType, status, remarks, photoData);
                };
                reader.readAsDataURL(photoFile);
            } else {
                debugLog('No photo file, proceeding without photo');
                saveEntryWithPhoto(date, destination, cashbill, consignment, courierType, status, remarks, null);
            }
        }
        
        function saveEntryWithPhoto(date, destination, cashbill, consignment, courierType, status, remarks, photoData) {
            try {
                debugLog('Saving entry with photo:', { date, destination, cashbill, consignment, courierType, status, hasPhoto: !!photoData });
                
                if (currentEntryId) {
                    // Edit existing entry
                    debugLog('Editing existing entry: ' + currentEntryId);
                    const entry = logbookEntries.find(e => e.id === currentEntryId);
                    if (entry) {
                        entry.date = date;
                        entry.destination = destination;
                        entry.cashbill = cashbill;
                        entry.consignment = consignment;
                        entry.courierType = courierType;
                        entry.status = status;
                        if (photoData) entry.photo = photoData;
                        entry.lastModified = getMalaysiaTime().toISOString();
                        
                        if (remarks) {
                            if (!entryRemarks[currentEntryId]) entryRemarks[currentEntryId] = [];
                            entryRemarks[currentEntryId].push({
                                text: remarks,
                                author: currentUser.name,
                                timestamp: getMalaysiaTime().toISOString()
                            });
                        }
                        
                        logActivity('Edit Entry', `Entry #${currentEntryId} edited by ${currentUser.name}`);
                        
                        if (isOnline) {
                            updateGoogleSheet(entry);
                        } else {
                            showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                        }
                    } else {
                        debugLog('Error: Entry not found for editing: ' + currentEntryId);
                        alert('Error: Entry not found');
                        return;
                    }
                } else {
                    // Add new entry with LBVM sequential ID
                    debugLog('Creating new entry...');
                    const newId = generateNextId();
                    debugLog('Generated new ID: ' + newId);
                    
                    const malaysiaTime = getMalaysiaTime();
                    
                    const newEntry = {
                        id: newId,
                        date: date,
                        pic: currentUser.name,
                        destination: destination,
                        cashbill: cashbill,
                        consignment: consignment,
                        courierType: courierType,
                        status: status,
                        photo: photoData,
                        committed: false,
                        createdBy: currentUser.id,
                        createdAt: malaysiaTime.toISOString(),
                        lastModified: malaysiaTime.toISOString()
                    };
                    
                    debugLog('Created new entry:', newEntry);
                    
                    logbookEntries.unshift(newEntry);
                    debugLog('Added entry to logbookEntries. Total entries: ' + logbookEntries.length);
                    
                    if (remarks) {
                        entryRemarks[newEntry.id] = [{
                            text: remarks,
                            author: currentUser.name,
                            timestamp: malaysiaTime.toISOString()
                        }];
                    }
                    
                    logActivity('Add Entry', `New entry created by ${currentUser.name}`);
                    
                    if (isOnline) {
                        debugLog('Submitting to Google Sheets...');
                        submitToGoogleSheet(newEntry);
                        showSuccessMessage('Entry created successfully and submitted to Google Sheets!');
                    } else {
                        debugLog('Offline mode - saving locally only');
                        showErrorMessage('You are offline. Entry saved locally and will be synced when you reconnect.');
                    }
                }
                
                debugLog('Saving to localStorage...');
                saveToLocalStorage();
                debugLog('Updating UI...');
                updateUI();
                debugLog('Closing modal...');
                bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
                debugLog('Entry saved successfully');
            } catch (error) {
                debugLog('Error saving entry: ' + error.message);
                console.error('Error saving entry:', error);
                alert('Error saving entry: ' + error.message);
            }
        }
        
        function editEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            currentEntryId = entryId;
            document.getElementById('entryModalTitle').textContent = 'Edit Entry';
            
            // Reset form and validation states
            const entryForm = document.getElementById('entryForm');
            entryForm.reset();
            entryForm.classList.remove('was-validated');
            
            // Remove validation classes
            entryForm.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryPIC').value = entry.pic;
            document.getElementById('entryDestination').value = entry.destination;
            document.getElementById('entryCashbill').value = entry.cashbill || '';
            document.getElementById('entryConsignment').value = entry.consignment || '';
            document.getElementById('entryCourierType').value = entry.courierType || '';
            document.getElementById('entryStatus').value = entry.status || '';
            document.getElementById('entryRemarks').value = '';
            document.getElementById('saveButtonText').textContent = 'Update Entry';
            
            if (entry.photo) {
                document.getElementById('photoPreview').innerHTML = `
                    <img src="${entry.photo}" class="photo-preview" alt="Entry photo preview">
                `;
            }
            
            new bootstrap.Modal(document.getElementById('entryModal')).show();
        }
        
        function deleteEntry(entryId) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            
            const entryIndex = logbookEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = logbookEntries.splice(entryIndex, 1)[0];
                deletedEntries.unshift(entry);
                logActivity('Delete Entry', `Entry #${entryId} deleted by ${currentUser.name}`);
                
                if (isOnline) {
                    deleteFromGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
            }
        }
        
        function commitEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            // Allow commit if:
            // 1. User is the creator of the entry, OR
            // 2. User is admin, OR
            // 3. User has canCommit permission AND is NOT the creator
            const isCreator = entry.createdBy === currentUser.id;
            
            if (!isCreator && currentUser.role !== 'admin' && !currentUser.canCommit) {
                showErrorMessage('You do not have permission to commit this entry.');
                return;
            }
            
            // Validate required fields before committing
            if (!entry.date || !entry.destination || !entry.cashbill || !entry.consignment || !entry.courierType || !entry.status) {
                showErrorMessage('Please fill in all required fields before committing.');
                return;
            }
            
            entry.committed = true;
            entry.committedBy = currentUser.id;
            entry.committedAt = getMalaysiaTime().toISOString();
            
            // Remove uncommit tracking if exists
            delete entry.uncommittedBy;
            delete entry.uncommittedAt;
            
            // Add system remark if this is a re-commit after uncommit
            if (entry.lastCommittedBy) {
                if (!entryRemarks[entryId]) {
                    entryRemarks[entryId] = [];
                }
                entryRemarks[entryId].push({
                    text: `Entry re-committed by ${currentUser.name}.`,
                    author: 'System',
                    timestamp: getMalaysiaTime().toISOString(),
                    isSystem: true
                });
            }
            
            entry.lastCommittedBy = currentUser.id;
            entry.lastCommittedAt = getMalaysiaTime().toISOString();
            
            logActivity('Commit Entry', `Entry #${entryId} committed by ${currentUser.name}`);
            
            if (isOnline) {
                updateGoogleSheet(entry);
            } else {
                showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
            }
            
            saveToLocalStorage();
            updateUI();
            
            if (entry.lastCommittedBy && entry.lastCommittedBy !== currentUser.id) {
                showSuccessMessage('Entry re-committed successfully!');
            } else {
                showSuccessMessage('Entry committed successfully!');
            }
        }
        
        function uncommitEntry(entryId) {
            // Only admin can uncommit entries
            if (currentUser.role !== 'admin') {
                showErrorMessage('Only administrators can uncommit entries. Please contact Danial Danish (ID: 7434).');
                return;
            }
            
            const entry = logbookEntries.find(e => e.id === entryId);
            if (entry) {
                entry.committed = false;
                entry.uncommittedBy = currentUser.id;
                entry.uncommittedAt = getMalaysiaTime().toISOString();
                delete entry.committedBy;
                delete entry.committedAt;
                
                // Notify the creator that their entry has been uncommitted
                const creator = users.find(u => u.id === entry.createdBy);
                if (creator && creator.id !== currentUser.id) {
                    // Add a system remark to notify the creator
                    if (!entryRemarks[entryId]) {
                        entryRemarks[entryId] = [];
                    }
                    entryRemarks[entryId].push({
                        text: `Admin has uncommitted this entry. You can now edit and re-commit it.`,
                        author: 'System',
                        timestamp: getMalaysiaTime().toISOString(),
                        isSystem: true
                    });
                }
                
                // Resolve any edit requests for this entry
                editRequests.forEach(req => {
                    if (req.entryId === entryId) {
                        req.resolved = true;
                        req.resolvedBy = currentUser.id;
                        req.resolvedAt = getMalaysiaTime().toISOString();
                    }
                });
                
                logActivity('Uncommit Entry', `Entry #${entryId} uncommitted by admin ${currentUser.name}`);
                
                // Force immediate sync to ensure all devices see the change
                if (isOnline) {
                    updateGoogleSheet(entry);
                    // Force a refresh of data from Google Sheets
                    setTimeout(() => {
                        loadDataFromGoogleSheets();
                    }, 1000);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
                showSuccessMessage('Entry uncommitted successfully! The creator can now edit and re-commit this entry.');
            }
        }
        
        function adminCommitEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (entry) {
                entry.committed = true;
                entry.committedBy = currentUser.id;
                entry.committedAt = getMalaysiaTime().toISOString();
                entry.lastCommittedBy = currentUser.id;
                entry.lastCommittedAt = getMalaysiaTime().toISOString();
                
                // Remove uncommit tracking
                delete entry.uncommittedBy;
                delete entry.uncommittedAt;
                
                logActivity('Admin Commit', `Entry #${entryId} re-committed by admin ${currentUser.name}`);
                
                if (isOnline) {
                    updateGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
                showSuccessMessage('Entry re-committed successfully by admin!');
            }
        }
        
        function restoreEntry(entryId) {
            const entryIndex = deletedEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = deletedEntries.splice(entryIndex, 1)[0];
                logbookEntries.unshift(entry);
                logActivity('Restore Entry', `Entry #${entryId} restored by ${currentUser.name}`);
                
                if (isOnline) {
                    updateGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
            }
        }
        
        function permanentlyDeleteEntry(entryId) {
            if (!confirm('Are you sure you want to permanently delete this entry? This cannot be undone.')) return;
            
            const entryIndex = deletedEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = deletedEntries.splice(entryIndex, 1)[0];
                delete entryRemarks[entryId];
                logActivity('Permanent Delete', `Entry #${entryId} permanently deleted by ${currentUser.name}`);
                
                if (isOnline) {
                    deleteFromGoogleSheet(entry);
                } else {
                    showErrorMessage('You are offline. Changes will be saved locally and synced when you reconnect.');
                }
                
                saveToLocalStorage();
                updateUI();
            }
        }
        
        function toggleDeletedEntries() {
            showingDeleted = !showingDeleted;
            const btn = document.getElementById('viewDeletedBtn');
            btn.innerHTML = showingDeleted ? 
                '<i class="fas fa-list me-1" aria-hidden="true"></i><span>Active</span>' : 
                '<i class="fas fa-trash me-1" aria-hidden="true"></i><span>Deleted</span>';
            
            // Clear search when switching between active and deleted entries
            clearSearch();
        }
        
        // Admin Contact Modal
        function showAdminContact() {
            new bootstrap.Modal(document.getElementById('adminContactModal')).show();
        }
        
        // Remarks Management
        function viewRemarks(entryId) {
            currentRemarksEntryId = entryId;
            const remarks = entryRemarks[entryId] || [];
            const remarksList = document.getElementById('remarksList');
            
            remarksList.innerHTML = '';
            if (remarks.length === 0) {
                remarksList.innerHTML = '<p class="text-muted">No remarks yet.</p>';
            } else {
                remarks.forEach(remark => {
                    const remarkDiv = document.createElement('div');
                    remarkDiv.className = 'remark-item';
                    if (remark.isSystem) {
                        remarkDiv.classList.add('system-remark');
                        remarkDiv.innerHTML = `
                            <div class="remark-author">
                                <i class="fas fa-info-circle me-1" aria-hidden="true"></i>${remark.author}
                            </div>
                            <div>${sanitizeHTML(remark.text)}</div>
                            <div class="remark-time">${formatMalaysiaDateTime(remark.timestamp)}</div>
                        `;
                    } else {
                        remarkDiv.innerHTML = `
                            <div class="remark-author">${remark.author}</div>
                            <div>${sanitizeHTML(remark.text)}</div>
                            <div class="remark-time">${formatMalaysiaDateTime(remark.timestamp)}</div>
                        `;
                    }
                    remarksList.appendChild(remarkDiv);
                });
            }
            
            document.getElementById('newRemark').value = '';
            new bootstrap.Modal(document.getElementById('remarksModal')).show();
        }
        
        function addRemark() {
            const remarkText = document.getElementById('newRemark').value.trim();
            if (!remarkText) return;
            
            if (!entryRemarks[currentRemarksEntryId]) {
                entryRemarks[currentRemarksEntryId] = [];
            }
            
            entryRemarks[currentRemarksEntryId].push({
                text: remarkText,
                author: currentUser.name,
                timestamp: getMalaysiaTime().toISOString()
            });
            
            logActivity('Add Remark', `Remark added to entry #${currentRemarksEntryId} by ${currentUser.name}`);
            saveToLocalStorage();
            viewRemarks(currentRemarksEntryId);
            filterAndRenderEntries();
        }
        
        // Edit Request Management with Enhanced Sync
        function requestEdit(entryId) {
            debugLog('Requesting edit for entry:', entryId);
            currentEntryId = entryId;
            document.getElementById('editRequestReason').value = '';
            
            // Ensure the modal is properly initialized
            const modalElement = document.getElementById('editRequestModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        function submitEditRequest() {
            const reason = document.getElementById('editRequestReason').value.trim();
            if (!reason) {
                alert('Please provide a reason for the edit request');
                return;
            }
            
            const request = {
                id: Date.now(),
                entryId: currentEntryId,
                requestedBy: currentUser.id,
                requestedByName: currentUser.name,
                reason: reason,
                timestamp: getMalaysiaTime().toISOString(),
                resolved: false
            };
            
            editRequests.unshift(request);
            logActivity('Edit Request', `Edit request submitted for entry #${currentEntryId} by ${currentUser.name}`);
            
            // Save locally first
            saveToLocalStorage();
            updateUI();
            
            // Sync with Google Sheets immediately
            if (isOnline) {
                syncEditRequestToGoogleSheets(request)
                    .then(() => {
                        showSuccessMessage('Edit request submitted and synced successfully!');
                    })
                    .catch(error => {
                        debugLog('Failed to sync edit request: ' + error.message);
                        showErrorMessage('Edit request submitted locally. Will sync when online.');
                    });
            } else {
                showSuccessMessage('Edit request submitted. Will sync when online.');
            }
            
            bootstrap.Modal.getInstance(document.getElementById('editRequestModal')).hide();
        }
        
        // Sync edit request to Google Sheets
        async function syncEditRequestToGoogleSheets(request) {
            const formData = new FormData();
            formData.append('action', 'sync_edit_request');
            formData.append('requestId', request.id);
            formData.append('entryId', request.entryId);
            formData.append('requestedBy', request.requestedBy);
            formData.append('requestedByName', request.requestedByName);
            formData.append('reason', request.reason);
            formData.append('timestamp', request.timestamp);
            formData.append('resolved', request.resolved);
            
            const response = await fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (data.result !== 'success') {
                throw new Error(data.error || 'Failed to sync edit request');
            }
            
            return data;
        }
        
        function updateEditRequestBadge() {
            const pendingRequests = editRequests.filter(r => !r.resolved).length;
            const badge = document.getElementById('editRequestBadge');
            
            if (currentUser.role === 'admin' && pendingRequests > 0) {
                badge.textContent = pendingRequests;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // User Management
        function loadUsersPage() {
            const usersList = document.getElementById('usersList');
            const usersTitle = document.getElementById('usersTitle');
            
            if (currentUser.role === 'admin') {
                usersTitle.textContent = 'All Users';
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'card mb-3';
                    userCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <div class="user-avatar mx-auto">${user.name.charAt(0)}</div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-1">${user.name}</h6>
                                    <p class="mb-1">ID: ${user.id}</p>
                                    <span class="badge ${user.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${user.role}</span>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="commit${user.id}" 
                                               ${user.canCommit ? 'checked' : ''} 
                                               onchange="toggleCommitPermission('${user.id}')"
                                               ${user.role === 'admin' ? 'disabled' : ''}
                                               aria-label="Toggle commit permission for ${user.name}">
                                        <label class="form-check-label" for="commit${user.id}">
                                            Can Commit Others' Entries
                                            <div class="permission-info">Everyone can commit their own entries</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    usersList.appendChild(userCard);
                });
                
                loadActivityLog();
            } else {
                usersTitle.textContent = 'My Profile';
                usersList.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <div class="user-avatar mx-auto" style="width: 80px; height: 80px; font-size: 2rem;">
                                        ${currentUser.name.charAt(0)}
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <h4>${currentUser.name}</h4>
                                    <p class="mb-1"><strong>ID:</strong> ${currentUser.id}</p>
                                    <p class="mb-1"><strong>Role:</strong> 
                                        <span class="badge ${currentUser.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${currentUser.role}</span>
                                    </p>
                                    <p class="mb-1"><strong>Outlet:</strong> VM:Switch VillageMall</p>
                                    <p class="mb-0"><strong>Can Commit Others' Entries:</strong> 
                                        <span class="badge ${currentUser.canCommit ? 'bg-success' : 'bg-danger'}">
                                            ${currentUser.canCommit ? 'Yes' : 'No'}
                                        </span>
                                        <div class="permission-info d-inline-block ms-2">
                                            <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                            You can always commit your own entries
                                        </div>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function toggleCommitPermission(userId) {
            const user = users.find(u => u.id === userId);
            if (user && user.role !== 'admin') {
                user.canCommit = !user.canCommit;
                logActivity('Toggle Permission', `Commit permission ${user.canCommit ? 'granted to' : 'revoked from'} ${user.name}`);
                saveToLocalStorage();
            }
        }
        
        function loadActivityLog() {
            const activityLog = document.getElementById('activityLog');
            activityLog.innerHTML = '';
            
            // Show edit requests first
            const pendingRequests = editRequests.filter(r => !r.resolved);
            if (pendingRequests.length > 0) {
                const requestsHeader = document.createElement('h6');
                requestsHeader.className = 'text-warning mb-3';
                requestsHeader.innerHTML = '<i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>Pending Edit Requests';
                activityLog.appendChild(requestsHeader);
                
                pendingRequests.forEach(request => {
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'activity-item bg-warning bg-opacity-10 border border-warning';
                    requestDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${request.requestedByName}</strong> requests edit for Entry #${request.entryId}
                                <br><small class="text-muted">${formatMalaysiaDateTime(request.timestamp)}</small>
                                <br><em>"${sanitizeHTML(request.reason)}"</em>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="approveEditRequest(${request.id})" aria-label="Approve edit request">
                                Approve
                            </button>
                        </div>
                    `;
                    activityLog.appendChild(requestDiv);
                });
            }
            
            // Show entries awaiting admin re-commit approval
            const uncommittedEntries = logbookEntries.filter(e => !e.committed && e.uncommittedBy);
            if (uncommittedEntries.length > 0) {
                const uncommittedHeader = document.createElement('h6');
                uncommittedHeader.className = 'text-info mb-3';
                uncommittedHeader.innerHTML = '<i class="fas fa-clock me-2" aria-hidden="true"></i>Entries Awaiting Re-commit Approval';
                activityLog.appendChild(uncommittedHeader);
                
                uncommittedEntries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'activity-item bg-info bg-opacity-10 border border-info';
                    entryDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>Entry #${entry.id}</strong> is uncommitted and awaiting re-commit
                                <br><small class="text-muted">Created by: ${entry.pic}</small>
                                <br><small class="text-muted">Uncommitted by: ${users.find(u => u.id === entry.uncommittedBy)?.name || 'Unknown'}</small>
                                <br><small class="text-muted">Uncommitted at: ${formatMalaysiaDateTime(entry.uncommittedAt)}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-1" onclick="adminCommitEntry('${entry.id}')" aria-label="Approve commit for entry ${entry.id}">
                                    <i class="fas fa-check" aria-hidden="true"></i> Approve Commit
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="viewEntryDetails('${entry.id}')" aria-label="View details for entry ${entry.id}">
                                    <i class="fas fa-eye" aria-hidden="true"></i> View
                                </button>
                            </div>
                        </div>
                    `;
                    activityLog.appendChild(entryDiv);
                });
            }
            
            // Show recent activity
            const recentLogs = activityLogs.slice(0, 10);
            if (recentLogs.length > 0) {
                const logsHeader = document.createElement('h6');
                logsHeader.className = 'text-primary mb-3';
                logsHeader.innerHTML = '<i class="fas fa-history me-2" aria-hidden="true"></i>Recent Activity';
                activityLog.appendChild(logsHeader);
                
                recentLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = 'activity-item';
                    logDiv.innerHTML = `
                        <strong>${log.action}</strong>
                        <br><small class="text-muted">${log.details}</small>
                        <br><small class="text-muted">${formatMalaysiaDateTime(log.timestamp)}</small>
                    `;
                    activityLog.appendChild(logDiv);
                });
            }
        }
        
        function approveEditRequest(requestId) {
            const request = editRequests.find(r => r.id === requestId);
            if (request) {
                // Update the request status
                request.resolved = true;
                request.resolvedBy = currentUser.id;
                request.resolvedAt = getMalaysiaTime().toISOString();
                request.status = 'approved';
                
                // Sync the approval to Google Sheets
                if (isOnline) {
                    syncEditRequestToGoogleSheets(request)
                        .then(() => {
                            uncommitEntry(request.entryId);
                            showSuccessMessage(`Edit request approved and synced successfully!`);
                        })
                        .catch(error => {
                            debugLog('Failed to sync approval: ' + error.message);
                            uncommitEntry(request.entryId);
                            showErrorMessage('Edit request approved. Sync will happen when online.');
                        });
                } else {
                    uncommitEntry(request.entryId);
                    showSuccessMessage('Edit request approved. Will sync when online.');
                }
            }
        }
        
        function viewEntryDetails(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            const modalHtml = `
            <div class="modal fade" id="entryDetailsModal" tabindex="-1" aria-labelledby="entryDetailsModalTitle" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="entryDetailsModalTitle">Entry Details - #${entry.id}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Date:</strong> ${formatMalaysiaDate(entry.date)}</p>
                                    <p><strong>PIC:</strong> ${entry.pic}</p>
                                    <p><strong>Destination:</strong> ${entry.destination}</p>
                                    <p><strong>Cashbill:</strong> ${entry.cashbill || 'N/A'}</p>
                                    <p><strong>Consignment:</strong> ${entry.consignment || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Courier Type:</strong> ${entry.courierType || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${entry.status || 'Not set'}</p>
                                    <p><strong>Created By:</strong> ${users.find(u => u.id === entry.createdBy)?.name || 'Unknown'}</p>
                                    <p><strong>Created At:</strong> ${formatMalaysiaDateTime(entry.createdAt)}</p>
                                    <p><strong>Last Modified:</strong> ${formatMalaysiaDateTime(entry.lastModified)}</p>
                                </div>
                            </div>
                            ${entry.photo ? `
                            <div class="mt-3">
                                <p><strong>Photo Proof:</strong></p>
                                <img src="${entry.photo}" class="img-fluid" style="max-height: 300px;" alt="Courier photo proof">
                            </div>
                            ` : ''}
                            ${entryRemarks[entry.id] ? `
                            <div class="mt-3">
                                <p><strong>Remarks:</strong></p>
                                <div class="remarks-list">
                                    ${entryRemarks[entry.id].map(remark => `
                                        <div class="remark-item ${remark.isSystem ? 'system-remark' : ''}">
                                            <div class="remark-author">
                                                ${remark.isSystem ? '<i class="fas fa-info-circle me-1" aria-hidden="true"></i>' : ''}${remark.author}
                                            </div>
                                            <div>${sanitizeHTML(remark.text)}</div>
                                            <div class="remark-time">${formatMalaysiaDateTime(remark.timestamp)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="adminCommitEntry('${entry.id}'); bootstrap.Modal.getInstance(document.getElementById('entryDetailsModal')).hide();" aria-label="Approve commit for entry ${entry.id}">
                                <i class="fas fa-check" aria-hidden="true"></i> Approve Commit
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            const existingModal = document.getElementById('entryDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('entryDetailsModal')).show();
        }
        
        // Admin Approvals Management
        function loadAdminApprovalsPage() {
            // Load edit requests
            const editRequestsList = document.getElementById('editRequestsList');
            const pendingRequests = editRequests.filter(r => !r.resolved);
            
            document.getElementById('editRequestsCount').textContent = pendingRequests.length;
            
            if (pendingRequests.length === 0) {
                editRequestsList.innerHTML = '<p class="text-muted">No pending edit requests.</p>';
            } else {
                editRequestsList.innerHTML = '';
                pendingRequests.forEach(request => {
                    const requestCard = document.createElement('div');
                    requestCard.className = 'card request-card mb-3';
                    requestCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="card-title">Edit Request for Entry #${request.entryId}</h6>
                                    <p class="mb-1"><strong>Requested by:</strong> ${request.requestedByName}</p>
                                    <p class="mb-1"><strong>Reason:</strong> ${sanitizeHTML(request.reason)}</p>
                                    <p class="text-muted mb-0"><small>${formatMalaysiaDateTime(request.timestamp)}</small></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-success me-2" onclick="approveEditRequest(${request.id})" aria-label="Approve edit request">
                                        <i class="fas fa-check me-1" aria-hidden="true"></i>Approve
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectEditRequest(${request.id})" aria-label="Reject edit request">
                                        <i class="fas fa-times me-1" aria-hidden="true"></i>Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    editRequestsList.appendChild(requestCard);
                });
            }
            
            // Load uncommitted entries
            const uncommittedEntriesList = document.getElementById('uncommittedEntriesList');
            const uncommittedEntries = logbookEntries.filter(e => !e.committed && e.uncommittedBy);
            
            document.getElementById('uncommittedCount').textContent = uncommittedEntries.length;
            
            if (uncommittedEntries.length === 0) {
                uncommittedEntriesList.innerHTML = '<p class="text-muted">No entries awaiting re-commit approval.</p>';
            } else {
                uncommittedEntriesList.innerHTML = '';
                uncommittedEntries.forEach(entry => {
                    const entryCard = document.createElement('div');
                    entryCard.className = 'card request-card mb-3';
                    entryCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="card-title">Entry #${entry.id}</h6>
                                    <p class="mb-1"><strong>PIC:</strong> ${entry.pic}</p>
                                    <p class="mb-1"><strong>Destination:</strong> ${entry.destination}</p>
                                    <p class="mb-1"><strong>Uncommitted by:</strong> ${users.find(u => u.id === entry.uncommittedBy)?.name || 'Unknown'}</p>
                                    <p class="text-muted mb-0"><small>Uncommitted at: ${formatMalaysiaDateTime(entry.uncommittedAt)}</small></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-success me-2" onclick="adminCommitEntry('${entry.id}')" aria-label="Approve commit for entry ${entry.id}">
                                        <i class="fas fa-check me-1" aria-hidden="true"></i>Approve Commit
                                    </button>
                                    <button class="btn btn-primary" onclick="viewEntryDetails('${entry.id}')" aria-label="View details for entry ${entry.id}">
                                        <i class="fas fa-eye me-1" aria-hidden="true"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    uncommittedEntriesList.appendChild(entryCard);
                });
            }
            
            updateAdminApprovalBadge();
        }
        
        function rejectEditRequest(requestId) {
            if (!confirm('Are you sure you want to reject this edit request?')) return;
            
            const request = editRequests.find(r => r.id === requestId);
            if (request) {
                // Update the request status
                request.resolved = true;
                request.resolvedBy = currentUser.id;
                request.resolvedAt = getMalaysiaTime().toISOString();
                request.status = 'rejected';
                
                // Sync the rejection to Google Sheets
                if (isOnline) {
                    syncEditRequestToGoogleSheets(request)
                        .then(() => {
                            logActivity('Reject Edit Request', `Edit request for entry #${request.entryId} rejected by ${currentUser.name}`);
                            saveToLocalStorage();
                            loadAdminApprovalsPage();
                            showSuccessMessage('Edit request rejected and synced successfully!');
                        })
                        .catch(error => {
                            debugLog('Failed to sync rejection: ' + error.message);
                            logActivity('Reject Edit Request', `Edit request for entry #${request.entryId} rejected by ${currentUser.name}`);
                            saveToLocalStorage();
                            loadAdminApprovalsPage();
                            showErrorMessage('Edit request rejected. Sync will happen when online.');
                        });
                } else {
                    logActivity('Reject Edit Request', `Edit request for entry #${request.entryId} rejected by ${currentUser.name}`);
                    saveToLocalStorage();
                    loadAdminApprovalsPage();
                    showSuccessMessage('Edit request rejected. Will sync when online.');
                }
            }
        }
        
        function updateAdminApprovalBadge() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const pendingRequests = editRequests.filter(r => !r.resolved).length;
            const uncommittedEntries = logbookEntries.filter(e => !e.committed && e.uncommittedBy).length;
            const total = pendingRequests + uncommittedEntries;
            
            const badge = document.getElementById('adminApprovalBadge');
            if (total > 0) {
                badge.textContent = total;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Utility Functions
        function handlePhotoPreview() {
            const file = document.getElementById('entryPhoto').files[0];
            const preview = document.getElementById('photoPreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="photo-preview" alt="Photo preview">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        }
        
        function viewPhoto(photoSrc) {
            document.getElementById('modalPhoto').src = photoSrc;
            new bootstrap.Modal(document.getElementById('photoModal')).show();
        }
        
        function logActivity(action, details) {
            activityLogs.unshift({
                action: action,
                details: details,
                user: currentUser.name,
                userId: currentUser.id,
                timestamp: getMalaysiaTime().toISOString()
            });
            saveToLocalStorage();
        }
        
        function updateUI() {
            if (currentUser) {
                loadLogbookPage();
                if (document.getElementById('usersPage').classList.contains('active')) {
                    loadUsersPage();
                }
                if (document.getElementById('adminApprovalsPage').classList.contains('active')) {
                    loadAdminApprovalsPage();
                }
                if (currentUser.role === 'admin') {
                    updateAdminApprovalBadge();
                }
            }
        }
        
        // Force sync function
        function forceSync() {
            if (!currentUser) return;
            
            if (!isOnline) {
                showErrorMessage('You are offline. Cannot sync with Google Sheets.');
                return;
            }
            
            showSuccessMessage('Force sync initiated...');
            loadDataFromGoogleSheets();
        }
        
        // Google Sheets Integration Functions
        function submitToGoogleSheet(entryData) {
            debugLog('Submitting to Google Sheets:', entryData);
            showSyncIndicator();
            
            const formData = new FormData();
            formData.append('date', entryData.date || '');
            formData.append('pic', entryData.pic || '');
            formData.append('destination', entryData.destination || '');
            formData.append('cashbill', entryData.cashbill || '');
            formData.append('consignment', entryData.consignment || '');
            formData.append('courierType', entryData.courierType || '');
            formData.append('status', entryData.status || '');
            formData.append('id', entryData.id || '');
            formData.append('committed', entryData.committed);
            formData.append('createdBy', entryData.createdBy || '');
            formData.append('createdAt', entryData.createdAt || '');
            formData.append('lastModified', entryData.lastModified || '');
            formData.append('action', 'submit');
            
            fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                debugLog('Google Sheets response status:', response.status);
                return response.json();
            })
            .then(data => {
                debugLog('Google Sheets response data:', data);
                if (data.result === 'success') {
                    console.log('Data submitted to Google Sheets successfully');
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Entry created successfully and submitted to Google Sheets!');
                } else {
                    console.error('Error submitting to Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error submitting to Google Sheets: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error submitting to Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while submitting to Google Sheets');
            });
        }
        
        function updateGoogleSheet(entryData) {
            showSyncIndicator();
            
            const formData = new FormData();
            formData.append('date', entryData.date || '');
            formData.append('pic', entryData.pic || '');
            formData.append('destination', entryData.destination || '');
            formData.append('cashbill', entryData.cashbill || '');
            formData.append('consignment', entryData.consignment || '');
            formData.append('courierType', entryData.courierType || '');
            formData.append('status', entryData.status || '');
            formData.append('id', entryData.id || '');
            formData.append('committed', entryData.committed);
            formData.append('createdBy', entryData.createdBy || '');
            formData.append('createdAt', entryData.createdAt || '');
            formData.append('lastModified', entryData.lastModified || '');
            formData.append('action', 'update');
            
            // Add uncommit tracking if exists
            if (entryData.uncommittedBy) {
                formData.append('uncommittedBy', entryData.uncommittedBy);
                formData.append('uncommittedAt', entryData.uncommittedAt);
            }
            
            fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    console.log('Data updated in Google Sheets successfully');
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Entry updated in Google Sheets successfully!');
                } else {
                    console.error('Error updating Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error updating Google Sheets: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while updating Google Sheets');
            });
        }
        
        function deleteFromGoogleSheet(entryData) {
            showSyncIndicator();
            
            const formData = new FormData();
            formData.append('id', entryData.id || '');
            formData.append('action', 'delete');
            
            fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    console.log('Data deleted from Google Sheets successfully');
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Entry deleted from Google Sheets successfully!');
                } else {
                    console.error('Error deleting from Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error deleting from Google Sheets: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting from Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while deleting from Google Sheets');
            });
        }
        
        function loadDataFromGoogleSheets() {
            if (!isOnline) {
                loadFromLocalStorage();
                showErrorMessage('You are offline. Loading data from local storage.');
                return;
            }
            
            showSyncIndicator();
            
            fetch(GOOGLE_SHEETS_URL + '?action=load_all&timestamp=' + Date.now())
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    const sheetData = data.data || [];
                    const sheetEditRequests = data.editRequests || [];
                    
                    // Process logbook entries
                    const existingEntriesMap = {};
                    logbookEntries.forEach(entry => {
                        existingEntriesMap[entry.id] = entry;
                    });
                    
                    sheetData.forEach(row => {
                        if (row.id && !existingEntriesMap[row.id]) {
                            // Try to find the user by name if createdBy is not available
                            let createdBy = row.createdBy || '';
                            if (!createdBy && row.pic) {
                                const user = users.find(u => u.name === row.pic);
                                if (user) {
                                    createdBy = user.id;
                                }
                            }
                            
                            const newEntry = {
                                id: row.id,
                                date: row.date || '',
                                pic: row.pic || '',
                                destination: row.destination || '',
                                cashbill: row.cashbill || '',
                                consignment: row.consignment || '',
                                courierType: row.courierType || '',
                                status: row.status || '',
                                committed: row.committed === 'TRUE' || row.committed === true,
                                createdBy: createdBy,
                                createdAt: row.createdAt || '',
                                lastModified: row.lastModified || ''
                            };
                            
                            // Add uncommit tracking if exists
                            if (row.uncommittedBy) {
                                newEntry.uncommittedBy = row.uncommittedBy;
                                newEntry.uncommittedAt = row.uncommittedAt;
                            }
                            
                            logbookEntries.push(newEntry);
                        }
                    });
                    
                    // Process edit requests
                    const existingRequestMap = {};
                    editRequests.forEach(request => {
                        existingRequestMap[request.id] = request;
                    });
                    
                    sheetEditRequests.forEach(request => {
                        if (!existingRequestMap[request.id]) {
                            editRequests.push(request);
                        } else {
                            // Update existing request with server data
                            const existingRequest = existingRequestMap[request.id];
                            if (request.resolved && !existingRequest.resolved) {
                                existingRequest.resolved = request.resolved;
                                existingRequest.resolvedBy = request.resolvedBy;
                                existingRequest.resolvedAt = request.resolvedAt;
                                existingRequest.status = request.status;
                                
                                // Show notification if current user is affected
                                if (request.requestedBy === currentUser.id) {
                                    showSuccessMessage('Your edit request has been ' + (request.status || 'processed'));
                                }
                            }
                        }
                    });
                    
                    // Sort entries by creation date
                    logbookEntries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    saveToLocalStorage();
                    updateUI();
                    hideSyncIndicator();
                    lastSyncTime = new Date();
                    showSuccessMessage('Data loaded from Google Sheets successfully!');
                } else {
                    console.error('Error syncing with Google Sheets:', data.error);
                    hideSyncIndicator();
                    showErrorMessage('Error syncing with Google Sheets: ' + data.error);
                    loadFromLocalStorage();
                }
            })
            .catch(error => {
                console.error('Error syncing with Google Sheets:', error);
                hideSyncIndicator();
                showErrorMessage('Network error while syncing with Google Sheets');
                loadFromLocalStorage();
            });
        }
        
        function syncWithGoogleSheets() {
            if (!currentUser) return;
            
            if (!isOnline) {
                showErrorMessage('You are offline. Cannot sync with Google Sheets.');
                return;
            }
            
            loadDataFromGoogleSheets();
        }
        
        function showSyncIndicator() {
            document.getElementById('syncIndicator').classList.add('show');
        }
        
        function hideSyncIndicator() {
            document.getElementById('syncIndicator').classList.remove('show');
        }
        
        function showRealTimeIndicator() {
            const indicator = document.getElementById('realTimeIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }
        
        function hideRealTimeIndicator() {
            document.getElementById('realTimeIndicator').classList.remove('show');
        }
        
        function showSuccessMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2" aria-hidden="true"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2" aria-hidden="true"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // Storage Management
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    users: users,
                    logbookEntries: logbookEntries,
                    deletedEntries: deletedEntries,
                    editRequests: editRequests,
                    activityLogs: activityLogs,
                    entryRemarks: entryRemarks,
                    lastSyncTime: lastSyncTime
                };
                localStorage.setItem('vmCourierData', JSON.stringify(dataToSave));
                debugLog('Data saved to localStorage successfully');
            } catch (error) {
                debugLog('Error saving to localStorage: ' + error.message);
                console.error('Error saving to localStorage:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('vmCourierData');
                if (data) {
                    const parsed = JSON.parse(data);
                    users = parsed.users || users;
                    logbookEntries = parsed.logbookEntries || [];
                    deletedEntries = parsed.deletedEntries || [];
                    editRequests = parsed.editRequests || [];
                    activityLogs = parsed.activityLogs || [];
                    entryRemarks = parsed.entryRemarks || {};
                    lastSyncTime = parsed.lastSyncTime || null;
                    updateUI();
                    debugLog('Data loaded from localStorage successfully');
                }
            } catch (error) {
                debugLog('Error loading from localStorage: ' + error.message);
                console.error('Error loading from localStorage:', error);
            }
        }
        
        // Security: Sanitize HTML to prevent XSS
        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Loading overlay functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
    </script>
</body>
</html>